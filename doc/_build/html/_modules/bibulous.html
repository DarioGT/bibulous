

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>bibulous &mdash; Bibulous 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Bibulous 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../index.html"><img src="../_static/banner.svg" border="0" height=300 alt="py4sci"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo_small.svg" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for bibulous</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: UTF-8 -*-</span>
<span class="c"># pylint: disable-msg=C0321</span>
<span class="c"># See the LICENSE.rst file for licensing information.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Bibulous is a drop-in replacement for BibTeX, with the primary advantage that the bibliography</span>
<span class="sd">template format is compact and *very* easy to modify.</span>

<span class="sd">The basic program flow is as follows:</span>
<span class="sd">(1) Read the .aux file and get the names of the bibliography databases (.bib files),</span>
<span class="sd">    the style templates (.bst files) to use, and the entire set of citations.</span>
<span class="sd">(2) Read in all of the bibliography database files into one long dictionary (`bibdata`),</span>
<span class="sd">    replacing any abbreviations with their full form. Cross-referenced data is *not* yet</span>
<span class="sd">    inserted at this point. That is delayed until the time of writing the BBL file in order</span>
<span class="sd">    to speed up parsing.</span>
<span class="sd">(3) Read in the Bibulous style template file as a dictionary (`bstdict`).</span>
<span class="sd">(4) Now that all the information is collected, go through each citation key, find the</span>
<span class="sd">    corresponding entry key in `bibdata`. From the entry type, select a template from `bstdict`</span>
<span class="sd">    and begin inserting the variables one-by-one into the template. If any data is missing,</span>
<span class="sd">    check for cross-references and use crossref data to fill in missing values.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>     <span class="c">## for Python3 compatibility</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">codecs</span>       <span class="c">## for importing UTF8-encoded files</span>
<span class="kn">import</span> <span class="nn">locale</span>       <span class="c">## for language internationalization and localization</span>
<span class="kn">import</span> <span class="nn">getopt</span>       <span class="c">## for getting command-line options</span>
<span class="kn">import</span> <span class="nn">traceback</span>    <span class="c">## for getting full traceback info in exceptions</span>
<span class="kn">import</span> <span class="nn">pdb</span>          <span class="c">## put &quot;pdb.set_trace()&quot; at any place you want to interact with pdb</span>

<span class="c">#def info(type, value, tb):</span>
<span class="c">#   #if (not sys.stderr.isatty() or</span>
<span class="c">#   #    not sys.stdin.isatty()):</span>
<span class="c">#   #    ## stdin or stderr is redirected, just do the normal thing</span>
<span class="c">#   #    original_hook(type, value, tb)</span>
<span class="c">#   #else:</span>
<span class="c">#   if True:</span>
<span class="c">#       ## a terminal is attached and stderr is not redirected, debug</span>
<span class="c">#       traceback.print_exception(type, value, tb)</span>
<span class="c">#       print(&#39;&#39;)</span>
<span class="c">#       pdb.pm()</span>
<span class="c">#       #traceback.print_stack()</span>
<span class="c">#sys.excepthook = info      ## go into debugger automatically on an exception</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;get_bibfilenames&#39;</span><span class="p">,</span> <span class="s">&#39;sentence_case&#39;</span><span class="p">,</span> <span class="s">&#39;stringsplit&#39;</span><span class="p">,</span> <span class="s">&#39;finditer&#39;</span><span class="p">,</span> <span class="s">&#39;namefield_to_namelist&#39;</span><span class="p">,</span>
           <span class="s">&#39;namedict_to_formatted_namestr&#39;</span><span class="p">,</span> <span class="s">&#39;initialize_name&#39;</span><span class="p">,</span> <span class="s">&#39;get_delim_levels&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_quote_levels&#39;</span><span class="p">,</span> <span class="s">&#39;splitat&#39;</span><span class="p">,</span> <span class="s">&#39;multisplit&#39;</span><span class="p">,</span> <span class="s">&#39;enwrap_nested_string&#39;</span><span class="p">,</span>
           <span class="s">&#39;enwrap_nested_quotes&#39;</span><span class="p">,</span> <span class="s">&#39;purify_string&#39;</span><span class="p">,</span> <span class="s">&#39;latex_to_utf8&#39;</span><span class="p">,</span> <span class="s">&#39;parse_bst_template_str&#39;</span><span class="p">,</span>
           <span class="s">&#39;namestr_to_namedict&#39;</span><span class="p">,</span> <span class="s">&#39;search_middlename_for_prefixes&#39;</span><span class="p">,</span> <span class="s">&#39;create_edition_ordinal&#39;</span><span class="p">,</span>
           <span class="s">&#39;export_bibfile&#39;</span><span class="p">,</span> <span class="s">&#39;parse_pagerange&#39;</span><span class="p">,</span> <span class="s">&#39;parse_nameabbrev&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Bibdata"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata">[docs]</a><span class="k">class</span> <span class="nc">Bibdata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bibdata is a class to hold all data related to a bibliography database, a citation list, and a</span>
<span class="sd">    style template.</span>

<span class="sd">    To initialize the class, either call it with the filename of the &quot;.aux&quot; file containing the</span>
<span class="sd">    relevant file locations (for the &quot;.bib&quot; database files and the &quot;.bst&quot; template files) or simply</span>
<span class="sd">    call it with a list of all filenames to be used (&quot;.bib&quot;, &quot;.bst&quot; and &quot;.aux&quot;). The output file</span>
<span class="sd">    (the LaTeX-formatted bibliography) is assumed to have the same filename root as the &quot;.aux&quot;</span>
<span class="sd">    file, but with &quot;.bbl&quot; as its extension.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    abbrevkey_pattern</span>
<span class="sd">    abbrevs</span>
<span class="sd">    anybrace_pattern</span>
<span class="sd">    anybraceorquote_pattern</span>
<span class="sd">    bibdata</span>
<span class="sd">    bstdict</span>
<span class="sd">    citedict</span>
<span class="sd">    debug</span>
<span class="sd">    endbrace_pattern</span>
<span class="sd">    filedict</span>
<span class="sd">    filename</span>
<span class="sd">    i</span>
<span class="sd">    options</span>
<span class="sd">    quote_pattern</span>
<span class="sd">    startbrace_pattern</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    parse_bibfile</span>
<span class="sd">    parse_bibentry</span>
<span class="sd">    parse_bibfield</span>
<span class="sd">    parse_auxfile</span>
<span class="sd">    parse_bstfile</span>
<span class="sd">    write_bblfile</span>
<span class="sd">    create_citation_list</span>
<span class="sd">    format_bibitem</span>
<span class="sd">    generate_sortkey</span>
<span class="sd">    create_namelist</span>
<span class="sd">    format_namelist</span>
<span class="sd">    insert_crossref_data</span>
<span class="sd">    write_citeextract</span>
<span class="sd">    write_authorextract</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ...</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;jan&#39;</span><span class="p">:</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;feb&#39;</span><span class="p">:</span><span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;mar&#39;</span><span class="p">:</span><span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="s">&#39;apr&#39;</span><span class="p">:</span><span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;may&#39;</span><span class="p">:</span><span class="s">&#39;5&#39;</span><span class="p">,</span> <span class="s">&#39;jun&#39;</span><span class="p">:</span><span class="s">&#39;6&#39;</span><span class="p">,</span>
                        <span class="s">&#39;jul&#39;</span><span class="p">:</span><span class="s">&#39;7&#39;</span><span class="p">,</span> <span class="s">&#39;aug&#39;</span><span class="p">:</span><span class="s">&#39;8&#39;</span><span class="p">,</span> <span class="s">&#39;sep&#39;</span><span class="p">:</span><span class="s">&#39;9&#39;</span><span class="p">,</span> <span class="s">&#39;oct&#39;</span><span class="p">:</span><span class="s">&#39;10&#39;</span><span class="p">,</span> <span class="s">&#39;nov&#39;</span><span class="p">:</span><span class="s">&#39;11&#39;</span><span class="p">,</span> <span class="s">&#39;dec&#39;</span><span class="p">:</span><span class="s">&#39;12&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>    <span class="c">## set the locale to the user&#39;s default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;preamble&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span> <span class="o">=</span> <span class="n">get_bibfilenames</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c">## the dictionary containing the original data from the AUX file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c">##citation keys in the ordered they will be printed in the final result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c">## Temporary variables for use in error messages while parsing files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>                      <span class="c">## the current filename (for error messages)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>                              <span class="c">## counter for line in file (for error messages)</span>

        <span class="c">## Put in default options settings.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;???&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;replace_newlines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;namelist_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;first_name_first&#39;</span>           <span class="c">#zzz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;citation_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;citenum&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;maxauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;maxeditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;minauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;mineditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;procspie_as_journal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;use_firstname_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>                    <span class="c">#zzz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;use_name_ties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>                            <span class="c">#zzz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;show_urls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;use_abbrevs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#self.options[&#39;hyperref&#39;] =</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;backrefstyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;backrefs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;sort_case&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;french_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;sort_with_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>                      <span class="c">#zzz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;terse_inits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;force_sentence_case&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;bibitemsep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;bibextract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;month_abbrev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c">## Compile some patterns for use in regex searches.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anybrace_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)[{}]&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startbrace_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">){&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endbrace_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)}&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)&quot;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbrevkey_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)[,#]&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anybraceorquote_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)[{}&quot;]&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

        <span class="c">## Print out some info on Bibulous and the files it is working on.</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;This is Bibulous, version &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">__version__</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;The current working directory is: &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;The top-level TeX file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;tex&#39;</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;The top-level auxiliary file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;aux&#39;</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;The bibliography database file(s): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bib&#39;</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;The Bibulous style template file(s): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bst&#39;</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;The output formatted bibliography file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bbl&#39;</span><span class="p">]))</span>

        <span class="c">## If &quot;filename&quot; is a list of filenames, then convert them one by one in order.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bib&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bib&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;aux&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_auxfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;aux&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bst&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bst&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bstfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ignore_overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="c">## =============================</span>
<div class="viewcode-block" id="Bibdata.parse_bibfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bibfile">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bibfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parse a *.bib file to generate a dictionary representing a bibliography database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the .bib file to parse.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c">#filehandle = open(os.path.normpath(self.filename), &#39;rU&#39;)</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c">## This next block parses the lines in the file into a dictionary. The tricky part here is</span>
        <span class="c">## that the BibTeX format allows for multiline entries. So we have to look for places where</span>
        <span class="c">## a line does not end in a comma, and check the following line to see if it a continuation</span>
        <span class="c">## of that line. Unfortunately, this means we need to read the whole file into memory ---</span>
        <span class="c">## not just one line at a time.</span>
        <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">## The variable &quot;entrystr&quot; contains all of the contents of the entry between the entrytype</span>
        <span class="c">## definition &quot;@____{&quot; and the closing brace &quot;}&quot;. Once we&#39;ve obtained all of the (in general</span>
        <span class="c">## multiline) contents, then we hand them off to parse_bibentry() to format them.</span>
        <span class="n">entrystr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">entrytype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c">## line number counter --- for error messages only</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">filehandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c">## Ignore empty and comment lines.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">):</span>
                <span class="c">## If a line *starts* with a closing brace, then assume the intent is to close the</span>
                <span class="c">## current entry.</span>
                <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibentry</span><span class="p">(</span><span class="n">entrystr</span><span class="p">,</span> <span class="n">entrytype</span><span class="p">)</span>       <span class="c">## close out the entry</span>
                <span class="n">entrystr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; has data &#39;</span>
                          <span class="s">&#39;outside of an entry {...} block. Skipping all contents until the next &#39;</span>
                          <span class="s">&#39;entry ...&#39;</span><span class="p">)</span>
                    <span class="c">#raise ValueError</span>
                <span class="k">continue</span>

            <span class="c">## Don&#39;t strip off leading and ending whitespace until after checking if &#39;}&#39; begins a</span>
            <span class="c">## line (as in the block above).</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c">#print(&#39;line=&#39;, line)        #zzz</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">brace_idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">)</span>             <span class="c">## assume a form like &quot;@ENTRYTYPE{&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">brace_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: open brace not found for the entry beginning on line#&#39;</span> <span class="o">+</span> \
                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot;. Skipping to next entry ...&#39;</span><span class="p">)</span>
                    <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>
                <span class="n">entrytype</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">brace_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>   <span class="c">## extract string between &quot;@&quot; and &quot;{&quot;</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">brace_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c">## If we are not current inside an active entry, then skip the line and wait until the</span>
            <span class="c">## the next entry.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; has data &#39;</span>
                          <span class="s">&#39;outside of an entry {...} block. Skipping all contents until the next &#39;</span>
                          <span class="s">&#39;entry ...&#39;</span><span class="p">)</span>
                    <span class="c">#raise ValueError</span>
                <span class="k">continue</span>

            <span class="c">## Look if the entry ends with this line. If so, append it to &quot;entrystr&quot; and call the</span>
            <span class="c">## entry parser. If not, then simply append to the string and continue.</span>
            <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anybrace_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">):</span>
                    <span class="n">entry_brace_level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">):</span>
                    <span class="n">entry_brace_level</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c">## If we&#39;ve found the final brace, then check if there is anything after it.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; has &#39;</span>
                              <span class="s">&#39;data outside of an entry {...} block. Skipping all contents until &#39;</span>
                              <span class="s">&#39;the next entry ...&#39;</span><span class="p">)</span>
                        <span class="c">#raise ValueError</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">entrystr</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[:</span><span class="n">endpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>         <span class="c">## use &quot;-1&quot; to remove the final closing brace</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibentry</span><span class="p">(</span><span class="n">entrystr</span><span class="p">,</span> <span class="n">entrytype</span><span class="p">)</span>
                <span class="n">entrystr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entrystr</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[:</span><span class="n">endpos</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.parse_bibentry"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bibentry">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bibentry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrystr</span><span class="p">,</span> <span class="n">entrytype</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a string representing the entire contents of the BibTeX-format bibliography entry,</span>
<span class="sd">        parse the contents and place them into the bibliography preamble string, the set of</span>
<span class="sd">        abbreviations, and the bibliography database dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrystr : str</span>
<span class="sd">            The string containing the entire contents of the bibliography entry.</span>
<span class="sd">        entrytype : str</span>
<span class="sd">            The type of entry (&quot;article&quot;, &quot;preamble&quot;, etc.).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entrystr</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s">&#39;comment&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s">&#39;preamble&#39;</span><span class="p">):</span>
            <span class="c">## In order to use the same &quot;parse_bibfield()&quot; function as all the other options, add a</span>
            <span class="c">## fake key onto the front of the string before calling &quot;parse_bibfield()&quot;.</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="s">&#39;fakekey = &#39;</span> <span class="o">+</span> <span class="n">entrystr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="s">&#39;preamble&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">fd</span><span class="p">[</span><span class="s">&#39;fakekey&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s">&#39;string&#39;</span><span class="p">):</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="n">entrystr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## First get the entry key. Then send the remainder of the entry string to the parser.</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">entrystr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                      <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; is does not have an &quot;,&quot; for defining the entry key. &#39;</span>
                      <span class="s">&#39;Skipping ...&#39;</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

            <span class="n">entrykey</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">entrystr</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;entrytype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entrytype</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="n">entrystr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.parse_bibfield"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bibfield">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bibfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrystr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For a given string representing the raw contents of a BibTeX-format bibliography entry,</span>
<span class="sd">        parse the contents into a dictionary of key:value pairs corresponding to the field</span>
<span class="sd">        names and field values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrystr : str</span>
<span class="sd">            The string containing the entire contents of the bibliography entry.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">## TODO: this function deperately needs some simplification!</span>

        <span class="n">entrystr</span> <span class="o">=</span> <span class="n">entrystr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="p">{}</span>             <span class="c">## the dictionary for holding key:value string pairs</span>

        <span class="k">while</span> <span class="n">entrystr</span><span class="p">:</span>
            <span class="c">## First locate the field key.</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">entrystr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                      <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; is an abbreviation-type entry but does not have an &quot;=&quot; &#39;</span>
                      <span class="s">&#39;for defining the end of the abbreviation key. Skipping ...&#39;</span><span class="p">)</span>
                <span class="c">#raise ValueError</span>
                <span class="k">return</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

            <span class="n">fieldkey</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldstr</span><span class="p">:</span>
                <span class="n">entrystr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">continue</span>

            <span class="c">## Next we go through the field contents, which may involve concatenating. When we</span>
            <span class="c">## reach the end of an individual field, we return the &quot;result string&quot; and</span>
            <span class="c">## truncate the entry string to remove the part we just finished parsing.</span>
            <span class="n">resultstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">while</span> <span class="n">fieldstr</span><span class="p">:</span>
                <span class="n">firstchar</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">):</span>
                    <span class="c">## Reached the end of the field, truncate the entry string return to the outer</span>
                    <span class="c">## loop over fields.</span>
                    <span class="n">fd</span><span class="p">[</span><span class="n">fieldkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultstr</span>
                    <span class="n">entrystr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="c">## Reached a concatenation operator. Just skip it.</span>
                    <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="c">## Search for the content string that resolves the double-quote delimiter.</span>
                    <span class="c">## Once you&#39;ve found the end delimiter, append the content string to the</span>
                    <span class="c">## result string.</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">)</span>
                    <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anybraceorquote_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">break</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">endpos</span><span class="p">]</span>
                    <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldstr</span><span class="p">:</span> <span class="n">entrystr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">):</span>
                    <span class="c">## Search for the endbrace that resolves the brace level. Once you&#39;ve found it,</span>
                    <span class="c">## add the intervening contents to the result string.</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">)</span>
                    <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anybrace_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">break</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">endpos</span><span class="p">]</span>
                    <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldstr</span><span class="p">:</span> <span class="n">entrystr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">## If the fieldstr doesn&#39;t begin with &#39;&quot;&#39; or &#39;{&#39; or &#39;#&#39;, then the next set of</span>
                    <span class="c">## characters must be an abbreviation key. An abbrev key ends with a whitespace</span>
                    <span class="c">## followed by either &#39;#&#39; or &#39;,&#39; (or the end of the field). Anything else is a</span>
                    <span class="c">## syntax error.</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">)</span>
                    <span class="n">end_of_field</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abbrevkey_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">):</span>
                        <span class="c">## If the &quot;abbrevkey&quot; is an integer, then it&#39;s not actually an abbreviation.</span>
                        <span class="c">## Convert it to a string and insert the number itself.</span>
                        <span class="n">abbrevkey</span> <span class="o">=</span> <span class="n">fieldstr</span>
                        <span class="k">if</span> <span class="n">abbrevkey</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">resultstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abbrevkey</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">abbrevkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">:</span>
                                <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrevkey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: for the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> \
                                      <span class="s">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot;, cannot find the &#39;</span>
                                      <span class="s">&#39;abbreviation key &quot;&#39;</span> <span class="o">+</span> <span class="n">abbrevkey</span> <span class="o">+</span> <span class="s">&#39;&quot;. Skipping ...&#39;</span><span class="p">)</span>
                                <span class="n">resultstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">]</span>
                        <span class="n">fieldstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="n">end_of_field</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abbrevkey_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">):</span>
                            <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">):</span>
                                <span class="n">abbrevkey</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[:</span><span class="n">endpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">abbrevkey</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abbrevkey</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="p">(</span><span class="n">abbrevkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">):</span>
                                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: for the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> \
                                          <span class="s">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot;, cannot find the &#39;</span>
                                          <span class="s">&#39;abbreviation key &quot;&#39;</span> <span class="o">+</span> <span class="n">abbrevkey</span> <span class="o">+</span> <span class="s">&#39;&quot;. Skipping ...&#39;</span><span class="p">)</span>
                                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrevkey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">break</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">):</span>
                                <span class="n">abbrevkey</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[:</span><span class="n">endpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">abbrevkey</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abbrevkey</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="p">(</span><span class="n">abbrevkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">):</span>
                                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: for the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> \
                                          <span class="s">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot;, cannot find the &#39;</span>
                                          <span class="s">&#39;abbreviation key &quot;&#39;</span> <span class="o">+</span> <span class="n">abbrevkey</span> <span class="o">+</span> <span class="s">&#39;&quot;. Skipping ...&#39;</span><span class="p">)</span>
                                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrevkey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                                <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="n">end_of_field</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s">&#39;Should never reach here. What happened?&#39;</span><span class="p">)</span>

                    <span class="c">## Since we found the comma at the end of this field&#39;s contents, we break here</span>
                    <span class="c">## to return to the loop over fields.</span>
                    <span class="k">if</span> <span class="n">end_of_field</span><span class="p">:</span>
                        <span class="n">entrystr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">break</span>

            <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;replace_newlines&#39;</span><span class="p">]:</span> <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>

            <span class="c">## Having braces around quotes can cause problems when parsing nested quotes, and</span>
            <span class="c">## do not provide any additional functionality.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;{&quot;}&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resultstr</span><span class="p">:</span>
                <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;{&quot;}&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&quot;{&#39;}&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resultstr</span><span class="p">:</span>
                <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;{&#39;}&quot;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;{`}&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resultstr</span><span class="p">:</span>
                <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;{`}&#39;</span><span class="p">,</span> <span class="s">&#39;`&#39;</span><span class="p">)</span>

            <span class="n">fd</span><span class="p">[</span><span class="n">fieldkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultstr</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.parse_auxfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_auxfile">[docs]</a>    <span class="k">def</span> <span class="nf">parse_auxfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read in an *.aux file and convert the `\citation{}` entries found there into a dictionary</span>
<span class="sd">        of citekeys and citation order number.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the *.aux file to parse.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Reading AUX file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; ...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c">#filehandle = open(os.path.normpath(self.filename), &#39;rU&#39;)</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c">## Commented lines below are useful if you are reading in \bibcite{...} rather than</span>
        <span class="c">## \citation{...}.</span>
        <span class="c">#for line in file.readlines():</span>
        <span class="c">#    line = unicode(line, &#39;utf-8&#39;)</span>
        <span class="c">#    if not line.startswith(r&#39;\bibcite&#39;): continue</span>
        <span class="c">#    line = line.replace(r&#39;\bibcite{&#39;,&#39;&#39;)</span>
        <span class="c">#</span>
        <span class="c">#    (citekey, number) = line.split(&#39;}{&#39;)</span>
        <span class="c">#    number = number.replace(&#39;}&#39;,&#39;&#39;).strip()</span>
        <span class="c">#    self.citedict[citekey] = int(number)</span>

        <span class="c">## First go through the file and grab the list of citation keys. Once we get them all, then</span>
        <span class="c">## we can go through the list and figure out the numbering.</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">filehandle</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">r&#39;\citation{&#39;</span><span class="p">):</span> <span class="k">continue</span>

            <span class="c">## Remove the &quot;\citeation{&quot; from the front and the &quot;}&quot; from the back. If multiple</span>
            <span class="c">## citations are given, then split them using the comma.</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">## If you didn&#39;t find any citations in the file, issue a warning. Otherwise, build a</span>
        <span class="c">## dictionary of keys giving the citation keys with values equal to the citation order</span>
        <span class="c">## number.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keylist</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: no citations found in AUX file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span>                       <span class="c">## citation order counter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">keylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">q</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="c">## When displaying the dictionary, show it in order-sorted form. Remember to use</span>
            <span class="c">## the user&#39;s locale for the sort.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="n">locale</span><span class="o">.</span><span class="n">strcoll</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="k">return</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.parse_bstfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bstfile">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bstfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ignore_overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert a Bibulous-type bibliography style template into a dictionary.</span>

<span class="sd">        The resulting dictionary consists of keys which are the various entrytypes, and values which \</span>
<span class="sd">        are the template strings. In addition, any formatting options are stored in the &quot;options&quot; key \</span>
<span class="sd">        as a dictionary of option_name:option_value pairs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the Bibulous style template to use.</span>
<span class="sd">        ignore_overwrite : bool, optional</span>
<span class="sd">            Whether to issue a warning when overwriting an existing template variable.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c">#filehandle = open(os.path.normpath(filename), &#39;rU&#39;)</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c">## First try to find out if the file is a BibTeX-style BST file rather than a Bibulous one.</span>
        <span class="c">## These files are not normally large, so reading in the whole thing should be quick.</span>
        <span class="n">alllines</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;EXECUTE {&#39;</span> <span class="ow">in</span> <span class="n">alllines</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;EXECUTE{&#39;</span> <span class="ow">in</span> <span class="n">alllines</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;The style template file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; appears to be BibTeX &#39;</span>
                              <span class="s">&#39;format, not Bibulous. Aborting...&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alllines</span><span class="p">):</span>
            <span class="c">## Ignore any comment lines, and remove any comments from data lines.</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; = &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s">&#39;The line &quot;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&#39;&quot; (line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;) in file &quot;&#39;</span> <span class="o">+</span> \
                                      <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; is not valid BST grammar.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c">## If the value is numeric or bool, then convert the datatype from string.</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;options.&#39;</span><span class="p">):</span>
                    <span class="c">## The variable defines an option rather than an entrytype.</span>
                    <span class="n">optvar</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">optvar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">optvar</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_overwrite</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: overwriting the existing template option &quot;&#39;</span> <span class="o">+</span> <span class="n">optvar</span> <span class="o">+</span> \
                              <span class="s">&#39;&quot; from [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">optvar</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;] to [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;] ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">optvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">## The line defines an entrytype template.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_overwrite</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: overwriting the existing template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> \
                              <span class="s">&#39;&quot; from [&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;] to [&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s">&#39;] ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">## Next check to see whether any of the template definitions are simply maps to one</span>
        <span class="c">## of the other definitions. For example, in &quot;osa.bst&quot; I have a line of the form</span>
        <span class="c">##      inbook = incollection</span>
        <span class="c">## which implies that the template for &quot;inbook&quot; should be mapped to the same template</span>
        <span class="c">## as defined for the &quot;incollection&quot; entrytype.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;options&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">nwords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&#39;\w+&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nwords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="c">## When displaying the bst dictionary, show it in sorted form.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="n">locale</span><span class="o">.</span><span class="n">strcoll</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.write_bblfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_bblfile">[docs]</a>    <span class="k">def</span> <span class="nf">write_bblfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_preamble</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">write_postamble</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bibsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a bibliography database `bibdata`, a dictionary containing the citations called out \</span>
<span class="sd">        `citedict`, and a bibliography style template `bstdict` write the LaTeX-format file for the \</span>
<span class="sd">        formatted bibliography.</span>

<span class="sd">        Start with the preamble and then loop over the citations one by one, formatting each entry \</span>
<span class="sd">        one at a time, and put `\end{thebibliography}` at the end when done.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            The filename of the *.bbl file to write. (Default is to take the AUX file and change \</span>
<span class="sd">            its extension to .bbl.)</span>
<span class="sd">        write_preamble : bool, optional</span>
<span class="sd">            Whether to write the preamble. (Setting this to False can be useful when writing the \</span>
<span class="sd">            bibliography in separate steps.)</span>
<span class="sd">        write_postamble : bool, optional</span>
<span class="sd">            Whether to write the postamble. (Setting this to False can be useful when writing the \</span>
<span class="sd">            bibliography in separate steps.)</span>
<span class="sd">        bibsize : str, optional</span>
<span class="sd">            A string the length of which is used to determine the label margin for the bibliography.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bbl&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">write_preamble</span><span class="p">:</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="c">## Create an inverse dictionary for the month names. The month names are determined by the</span>
        <span class="c">## user&#39;s default locale.</span>
        <span class="n">monthname_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;month_abbrev&#39;</span><span class="p">]:</span>
                <span class="n">monthname_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">nl_langinfo</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&#39;ABMON_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">monthname_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">nl_langinfo</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&#39;MON_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">write_preamble</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bibsize</span><span class="p">:</span> <span class="n">bibsize</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">))</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">begin{thebibliography}{&#39;</span> <span class="o">+</span> <span class="n">bibsize</span> <span class="o">+</span> <span class="s">&#39;}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="c">#if self.options[&#39;show_urls&#39;]: filehandle.write(r&#39;\providecommand{\url}[1]{\texttt{#1}}&#39;)</span>
            <span class="c">#if not self.options[&#39;show_urls&#39;]:</span>
            <span class="c">#    filehandle.write(r&#39;\providecommand{\url}[1]{}&#39;)              ## i.e. ignore the URL</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">providecommand{</span><span class="se">\\</span><span class="s">enquote}[1]{``#1&#39;&#39;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">providecommand{</span><span class="se">\\</span><span class="s">url}[1]{</span><span class="se">\\</span><span class="s">verb|#1|}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">providecommand{</span><span class="se">\\</span><span class="s">href}[2]{#2}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;bibitemsep&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">setlength{</span><span class="se">\\</span><span class="s">itemsep}{&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;bibitemsep&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;}</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;preamble&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="s">&#39;preamble&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="c">## Define a list which contains the citation keys, sorted in the order in which we need for</span>
        <span class="c">## writing into the BBL file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_citation_list</span><span class="p">()</span>

        <span class="c">## Write out each individual bibliography entry. Some formatting options will actually cause</span>
        <span class="c">## the entry to be deleted, so we need the check below to see if the return string is empty</span>
        <span class="c">## before writing it to the file.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">:</span>
            <span class="c">## Verbose output is for debugging.</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Writing entry &quot;&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">&#39;&quot; to &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;&quot; ...&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert_crossref_data</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_namelist</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#39;author&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_namelist</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#39;editor&#39;</span><span class="p">)</span>

            <span class="c">## Before inserting entries into the BBL file, we do &quot;difficult&quot; BIB parsing jobs</span>
            <span class="c">## here: insert cross-reference data, format author and editor name lists, generate</span>
            <span class="c">## the &quot;edition_ordinal&quot;, etc. Doing it here means that we don&#39;t have to add lots of</span>
            <span class="c">## extra checks later, allowing for simpler code.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;edition_ordinal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_edition_ordinal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;pages&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
                <span class="p">(</span><span class="n">startpage</span><span class="p">,</span><span class="n">endpage</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_pagerange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;pages&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;startpage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startpage</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;endpage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpage</span>

            <span class="c">## The &quot;month&quot; is stored in the bibdata dictionary as a string representing an integer</span>
            <span class="c">## from 1 to 12. Here we need to translate it to a string name.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;month&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">monthname</span> <span class="o">=</span> <span class="n">monthname_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;month&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">monthname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;month&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;monthname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthname</span>

            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_bibitem</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
                <span class="c">## Need two line EOL&#39;s here and not one so that backrefs can work properly.</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">write_postamble</span><span class="p">:</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\\</span><span class="s">end{thebibliography}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="c">## ===================================</span></div>
<div class="viewcode-block" id="Bibdata.create_citation_list"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.create_citation_list">[docs]</a>    <span class="k">def</span> <span class="nf">create_citation_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the list of citation keys, sorted into the proper order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        citelist : list</span>
<span class="sd">            The sorted list of citation keys.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c">## The &quot;citelist&quot; consists of tuples containing the new sort key and the original citation</span>
        <span class="c">## key.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_sortkey</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sortkey</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>

        <span class="c">## Now that we have the sortkeys, sort the citation list in numerical order. (Since each</span>
        <span class="c">## element of citelist is a tuple whose first element is an integer, we need not use</span>
        <span class="c">## locale-dependent sorting here.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c">## If using a citation order which is descending rather than ascending, then reverse the list.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;citation_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ydnt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c">## If any duplicate sorting keys exist, append a label onto the end in order to make them</span>
        <span class="c">## unique. It doesn&#39;t matter what you append, just so long as it makes the key unique, so we</span>
        <span class="c">## use the entry&#39;s index in the list of keys.</span>
        <span class="c">#sortkeys = [key for (key,val) in self.citelist]</span>
        <span class="c">#sortkeys = [x+str(i) for i,x in enumerate(sortkeys) if sortkeys.count(x)&gt;1]</span>
        <span class="c">#citekeys = [val for (key,val) in self.citelist]</span>
        <span class="c">#citekeys = [x+str(i) for i,x in enumerate(citekeys) if citekeys.count(x)&gt;1]</span>

        <span class="c">## Finally, now that we have them in the order we want, we keep only the citation keys, so</span>
        <span class="c">## that we know which entry maps to which in the *.aux file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">]</span>

        <span class="k">return</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.format_bibitem"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.format_bibitem">[docs]</a>    <span class="k">def</span> <span class="nf">format_bibitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citekey</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the &quot;\bibitem{...}&quot; string to insert into the *.bbl file.</span>

<span class="sd">        This is the workhorse function of Bibulous. For a given key, find the resulting entry</span>
<span class="sd">        in the bibliography database. From the entry&#39;s `entrytype`, lookup the relevant template</span>
<span class="sd">        in bstdict and start replacing template variables with formatted elements of the database</span>
<span class="sd">        entry. Once you&#39;ve replaced all template variables, you&#39;re done formatting that entry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        citekey : str</span>
<span class="sd">            The citation key.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        itemstr : str</span>
<span class="sd">            The string containing the \bibitem{} citation key and LaTeX-formatted string for the</span>
<span class="sd">            formatted bibliography. (That is, this string is designed to be inserted directly into</span>
<span class="sd">            the LaTeX document.)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">citekey</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;citation_order&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;citenumber&#39;</span><span class="p">,</span><span class="s">&#39;citenum&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">)):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="s">r&#39;\bibitem{&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">&#39;}</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="s">r&#39;\bibitem[&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">&#39;]{&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">&#39;}</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="c">## If the citation key is not in the database, replace the format string with a message to the</span>
        <span class="c">## fact.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: citation key &quot;&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">&#39;&quot; is not in the bibliography database.&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">itemstr</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">textit{Warning: citation key is not in the bibliography database}.&#39;</span><span class="p">)</span>

        <span class="n">entrytype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;entrytype&#39;</span><span class="p">]</span>

        <span class="c">## If the journal format uses ProcSPIE like a journal, then you need to change the entrytype</span>
        <span class="c">## from &quot;inproceedings&quot; to &quot;article&quot;, and add a &quot;journal&quot; field.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;procspie_as_journal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;entrytype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;inproceedings&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="s">&#39;series&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;series&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Proc. SPIE&#39;</span><span class="p">,</span><span class="s">&#39;procspie&#39;</span><span class="p">]):</span>
            <span class="n">entrytype</span> <span class="o">=</span> <span class="s">&#39;article&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;entrytype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;article&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;journal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Proc. SPIE&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">entrytype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">entrytype</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: entrytype &quot;&#39;</span> <span class="o">+</span> <span class="n">entrytype</span> <span class="o">+</span> <span class="s">&#39;&quot; does not have a template defined in the &#39;</span>
                  <span class="s">&#39;.bst file.&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">itemstr</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">textit{Warning: entrytype &quot;&#39;</span> <span class="o">+</span> <span class="n">entrytype</span> <span class="o">+</span> <span class="s">&#39;&quot; does not have a &#39;</span>
                   <span class="s">&#39;template defined in the .bst file}.&#39;</span><span class="p">)</span>

        <span class="c">## Process the optional arguments. First check the syntax. Make sure that there are the same</span>
        <span class="c">## number of open as closed brackets.</span>
        <span class="n">num_obrackets</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)</span>
        <span class="n">num_cbrackets</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">num_obrackets</span> <span class="o">==</span> <span class="n">num_cbrackets</span><span class="p">),</span> <span class="s">&#39;There are &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_obrackets</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s">&#39; open brackets &quot;[&quot;, but &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cbrackets</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; close brackets &quot;]&quot; in the &#39;</span> <span class="o">+</span> \
            <span class="s">&#39;formatting string.&#39;</span>

        <span class="c">## Get the list of all the variables used by the template string.</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span>

        <span class="c">## Next, do a nested search. From the beginning of the formatting string look for the first</span>
        <span class="c">## &#39;[&#39;, and the first &#39;]&#39;. If they are out of order, raise an exception. Note that this</span>
        <span class="c">## assumes that the square brackets cannot be nested. (Is there something important which</span>
        <span class="c">## would require that functionality?)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_obrackets</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">start_idx</span> <span class="o">&lt;</span> <span class="n">end_idx</span><span class="p">),</span> <span class="s">&#39;A closed bracket &quot;]&quot; occurs before an open bracket &#39;</span> <span class="o">+</span> \
                    <span class="s">&#39;&quot;[&quot; in the format str &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s">&#39;&quot;.&#39;</span>

            <span class="c">## Remove the outer square brackets, and use the resulting substring as an input to the</span>
            <span class="c">## parser.</span>
            <span class="n">substr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">start_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="c">## In each options train, go through and replace the whole train with the one block that</span>
            <span class="c">## has a defined value.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">parse_bst_template_str</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">variables</span><span class="p">,</span>
                                         <span class="n">undefstr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">])</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[:</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c">## Next go through the template and replace each variable with the appropriate string from</span>
        <span class="c">## the database. Start with the three special cases.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;&lt;authorliststr&gt;&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;authorlist&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;authorliststr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_namelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;authorlist&#39;</span><span class="p">],</span> <span class="s">&#39;author&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;&lt;editorliststr&gt;&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;editorlist&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;editorliststr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_namelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;editorlist&#39;</span><span class="p">],</span> <span class="s">&#39;editor&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;title&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;force_sentence_case&#39;</span><span class="p">]:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">sentence_case</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;title&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s">&#39;title&#39;</span><span class="p">]</span>

            <span class="c">## If the template string has punctuation right after the title, and the title itself</span>
            <span class="c">## also has punctuation, then you may get something like &quot;Title?,&quot; where the two</span>
            <span class="c">## punctuation marks conflict. In that case, keep the title&#39;s punctuation and drop the</span>
            <span class="c">## template&#39;s.</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s">&#39;?&#39;</span><span class="p">,</span><span class="s">&#39;!&#39;</span><span class="p">)):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">)]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;!&#39;</span><span class="p">,</span><span class="s">&#39;?&#39;</span><span class="p">,</span><span class="s">&#39;;&#39;</span><span class="p">,</span><span class="s">&#39;:&#39;</span><span class="p">)):</span>
                    <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">):]</span>
                    <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

        <span class="c">## Remove the special cases from the variables list --- we already replaced these above.</span>
        <span class="c">## (Right now there is only &lt;title&gt; here, but we can add more.)</span>
        <span class="n">specials_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&lt;title&gt;&#39;</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specials_list</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>     <span class="c">## remove angle brackets to extract just the name</span>
                <span class="c">## Check if the variable is defined and that it is not None (or empty string).</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">varname</span><span class="p">]:</span>
                    <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">varname</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">#print(&#39;Warning: cannot find &quot;&#39; + varname + &#39;&quot; in entry &quot;&#39; + c + &#39;&quot;.&#39;)</span>
                    <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">])</span>

        <span class="c">## Add the template string onto the &quot;\bibitem{...}\n&quot; line in front of it.</span>
        <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span> <span class="o">+</span> <span class="n">templatestr</span>

        <span class="c">## Now that we&#39;ve replaced template variables, go ahead and replace the special commands.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;{\makeopenbracket}&#39;</span> <span class="ow">in</span> <span class="n">itemstr</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;{\makeopenbracket}&#39;</span><span class="p">,</span> <span class="s">&#39;[&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;{\makeclosebracket}&#39;</span> <span class="ow">in</span> <span class="n">itemstr</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;{\makeclosebracket}&#39;</span><span class="p">,</span> <span class="s">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;{\makeverticalbar}&#39;</span> <span class="ow">in</span> <span class="n">itemstr</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;{\makeverticalbar}&#39;</span><span class="p">,</span> <span class="s">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;{\makegreaterthan}&#39;</span> <span class="ow">in</span> <span class="n">itemstr</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;{\makegreaterthan}&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;{\makelessthan}&#39;</span> <span class="ow">in</span> <span class="n">itemstr</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;{\makelessthan}&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">)</span>

        <span class="c">## If there are nested operators on the string, replace all even-level operators with \{}.</span>
        <span class="c">## Is there any need to do this with \textbf{} and \texttt{} as well?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">itemstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">textit{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">enwrap_nested_string</span><span class="p">(</span><span class="n">itemstr</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">),</span> <span class="n">odd_operator</span><span class="o">=</span><span class="s">r&#39;\textit&#39;</span><span class="p">,</span> \
                                           <span class="n">even_operator</span><span class="o">=</span><span class="s">r&#39;\textup&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">itemstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">textbf{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">enwrap_nested_string</span><span class="p">(</span><span class="n">itemstr</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">),</span> <span class="n">odd_operator</span><span class="o">=</span><span class="s">r&#39;\textbf&#39;</span><span class="p">,</span> \
                                           <span class="n">even_operator</span><span class="o">=</span><span class="s">r&#39;\textmd&#39;</span><span class="p">)</span>

        <span class="c">## If there are any nested quotation marks in the string, then we need to modify the</span>
        <span class="c">## formatting properly. If there are any apostrophes or foreign words that use apostrophes</span>
        <span class="c">## in the string then the current code will raise an exception.</span>
        <span class="n">itemstr</span> <span class="o">=</span> <span class="n">enwrap_nested_quotes</span><span class="p">(</span><span class="n">itemstr</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">itemstr</span><span class="p">)</span>

    <span class="c">## ===================================</span></div>
<div class="viewcode-block" id="Bibdata.generate_sortkey"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.generate_sortkey">[docs]</a>    <span class="k">def</span> <span class="nf">generate_sortkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citekey</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        From a bibliography entry and the formatting template options, generate a sorting key for the</span>
<span class="sd">        entry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        citekey : str</span>
<span class="sd">            The key for the current entry.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sortkey : str</span>
<span class="sd">            A string to use as a sorting key.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">## When a given citation key is not found in the database, return a warning. However, if the</span>
        <span class="c">## citeorder if just &quot;citekey&quot; then we *already* know how to sort it, so rather than return a</span>
        <span class="c">## warning go ahead and return the citekey so that it gets sorted properly. The fact that the</span>
        <span class="c">## key is not in the database will raise an error later.</span>
        <span class="n">citeorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;citation_order&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">citeorder</span> <span class="o">==</span> <span class="s">&#39;citekey&#39;</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">citekey</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">citekey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="s">&#39;Warning: &quot;&#39;</span> <span class="o">+</span> <span class="n">citekey</span> <span class="o">+</span> <span class="s">&#39;&quot; is not in the bibliography database.&#39;</span><span class="p">)</span>

        <span class="n">bibentry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">citekey</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;sortkey&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;sortkey&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">citeorder</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;citenum&#39;</span><span class="p">,</span><span class="s">&#39;citenumber&#39;</span><span class="p">)):</span>
            <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">citekey</span><span class="p">])</span>

        <span class="n">namelist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c">## Use the name abbreviation (if it exists) in the sortkey.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;sortname&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;nameabbrev&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;sortname&#39;</span><span class="p">]):</span>
            <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="n">parse_nameabbrev</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;sortname&#39;</span><span class="p">][</span><span class="s">&#39;nameabbrev&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;nameabbrev&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">[</span><span class="n">citekey</span><span class="p">]):</span>
            <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="n">parse_nameabbrev</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="n">citekey</span><span class="p">][</span><span class="s">&#39;nameabbrev&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">## Extract the last name of the first author.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;sortname&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
            <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;sortname&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">citekey</span><span class="p">,</span>
                                             <span class="n">nameabbrev</span><span class="o">=</span><span class="n">nameabbrev_dict</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;last&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;first&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">name</span> <span class="o">+=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;first&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;middle&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">name</span> <span class="o">+=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;middle&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;author&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_namelist</span><span class="p">(</span><span class="n">citekey</span><span class="p">,</span> <span class="s">&#39;author&#39;</span><span class="p">)</span>
                <span class="n">namelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">citekey</span><span class="p">][</span><span class="s">&#39;authorlist&#39;</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;last&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;sort_with_prefix&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&#39;first&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">name</span> <span class="o">+=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;first&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&#39;middle&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">name</span> <span class="o">+=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;middle&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;editor&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_namelist</span><span class="p">(</span><span class="n">citekey</span><span class="p">,</span> <span class="s">&#39;editor&#39;</span><span class="p">)</span>
                <span class="n">namelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">citekey</span><span class="p">][</span><span class="s">&#39;editorlist&#39;</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;last&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;sort_with_prefix&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&#39;first&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">name</span> <span class="o">+=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;first&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&#39;middle&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">name</span> <span class="o">+=</span> <span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;middle&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;organization&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;organization&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;institution&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;institution&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="c">## Names that have initials will have unwanted &#39;.&#39;s in them.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;sortyear&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;sortyear&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="s">&#39;9999&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;year&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">])</span>

        <span class="c">## &quot;presort&quot; is a string appended to the beginning of each sortkey. This can be useful for</span>
        <span class="c">## grouping entries.</span>
        <span class="n">presort</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;presort&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;presort&#39;</span><span class="p">])</span>

        <span class="c">## &quot;sorttitle&quot; is an alternative title used for sorting. Can be useful if the title contains</span>
        <span class="c">## special characters and LaTeX commands.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;sorttitle&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;sorttitle&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">)</span> <span class="k">else</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>

        <span class="n">volume</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;volume&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;volume&#39;</span><span class="p">])</span>

        <span class="c">## The different formatting options for the citation order are &quot;nty&quot;/&quot;plain&quot;, &quot;nyt&quot;, &quot;nyvt&quot;,</span>
        <span class="c">## &quot;anyt&quot;, &quot;anyvt&quot;, ynt&quot;, and &quot;ydnt&quot;.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">citeorder</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;nyt&#39;</span><span class="p">,</span><span class="s">&#39;plain&#39;</span><span class="p">)):</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">title</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">citeorder</span> <span class="o">==</span> <span class="s">&#39;nty&#39;</span><span class="p">):</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="n">year</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">citeorder</span> <span class="o">==</span> <span class="s">&#39;nyvt&#39;</span><span class="p">):</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">volume</span> <span class="o">+</span> <span class="n">title</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">citeorder</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;ynt&#39;</span><span class="p">,</span><span class="s">&#39;ydnt&#39;</span><span class="p">)):</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">title</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">citeorder</span> <span class="o">==</span> <span class="s">&#39;alpha&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">namelist</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">citeorder</span> <span class="o">==</span> <span class="s">&#39;anyt&#39;</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;alphalabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">citekey</span><span class="p">])</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">citekey</span><span class="p">][</span><span class="s">&#39;alphalabel&#39;</span><span class="p">]</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">title</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">citeorder</span> <span class="o">==</span> <span class="s">&#39;anyvt&#39;</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;alphalabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">citekey</span><span class="p">])</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">citekey</span><span class="p">][</span><span class="s">&#39;alphalabel&#39;</span><span class="p">]</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">presort</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">volume</span> <span class="o">+</span> <span class="n">title</span>
        <span class="c">#elif (citeorder in (&#39;citenumber&#39;,&#39;citenum&#39;,&#39;none&#39;)):</span>
        <span class="c">#    raise ValueError(&#39;Wrong citation sort order option. How did this happen?&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;That citation sort order (&quot;&#39;</span> <span class="o">+</span> <span class="n">citeorder</span> <span class="o">+</span> <span class="s">&#39;&quot;) is not supported.&#39;</span><span class="p">)</span>

        <span class="n">sortkey</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">sortkey</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;sort_case&#39;</span><span class="p">]:</span>
            <span class="n">sortkey</span> <span class="o">=</span> <span class="n">sortkey</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">sortkey</span><span class="p">)</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.create_namelist"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.create_namelist">[docs]</a>    <span class="k">def</span> <span class="nf">create_namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">nametype</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Deconstruct the bibfile string following &quot;author = ...&quot; (or &quot;editor = ...&quot;), and create a</span>
<span class="sd">        new field `authorlist` or `editorlist` that is a list of dictionaries (one dict for each</span>
<span class="sd">        person).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            The key in `bibdata` defining the current entry being formatted.</span>
<span class="sd">        nametype : str, {&#39;author&#39;,&#39;editor&#39;}</span>
<span class="sd">            Which bibliography field to use for parsing names.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">## First check that the entrykey exists.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c">## If the name field does not exist, we can&#39;t define name dictionaries, so exit. Note that</span>
        <span class="c">## we need not check for cross-reference data, since we will assume that has already been</span>
        <span class="c">## done.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nametype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c">## If the namelist is already defined, then there is nothing to do!</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nametype</span><span class="o">+</span><span class="s">&#39;list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c">## The name abbreviations are assumed to be used for generating initials, and so skip</span>
        <span class="c">## using abbrevations when not initializing.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;use_firstname_initials&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;nameabbrev&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="n">parse_nameabbrev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;nameabbrev&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">## Convert the raw string containing author/editor names in the BibTeX field into a list</span>
        <span class="c">## of dictionaries --- one dict for each person.</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">nametype</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                         <span class="n">nameabbrev</span><span class="o">=</span><span class="n">nameabbrev_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">nametype</span><span class="o">+</span><span class="s">&#39;list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namelist</span>

        <span class="k">return</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.format_namelist"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.format_namelist">[docs]</a>    <span class="k">def</span> <span class="nf">format_namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namelist</span><span class="p">,</span> <span class="n">nametype</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Format a list of dictionaries (one dict for each person) into a long string, with the</span>
<span class="sd">        format according to the directives in the bibliography style template.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        namelist : str</span>
<span class="sd">            The list of dictionaries containing all of the names to be formatted.</span>
<span class="sd">        nametype : str, {&#39;author&#39;, &#39;editor&#39;}</span>
<span class="sd">            Whether the names are for authors or editors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namestr : str</span>
<span class="sd">            The formatted form of the &quot;name string&quot;. This is generally a list of authors or list \</span>
<span class="sd">            of editors.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">use_first_inits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;use_firstname_initials&#39;</span><span class="p">]</span>
        <span class="n">namelist_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;namelist_format&#39;</span><span class="p">]</span>

        <span class="c">## First get all of the options variables needed below, depending on whether the function is</span>
        <span class="c">## operating on a list of authors or a list of editors. Second, insert &quot;authorlist&quot; into the</span>
        <span class="c">## bibliography database entry so that other functions can have access to it. (This is the</span>
        <span class="c">## &quot;author&quot; or &quot;editor&quot; string parsed into individual names, so that each person&#39;s name is</span>
        <span class="c">## represented by a dictionary, and the whole set of names is a list of dicts.)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nametype</span> <span class="o">==</span> <span class="s">&#39;author&#39;</span><span class="p">):</span>
            <span class="n">maxnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;maxauthors&#39;</span><span class="p">]</span>
            <span class="n">minnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;minauthors&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">nametype</span> <span class="o">==</span> <span class="s">&#39;editor&#39;</span><span class="p">):</span>
            <span class="n">maxnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;maxeditors&#39;</span><span class="p">]</span>
            <span class="n">minnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;mineditors&#39;</span><span class="p">]</span>

        <span class="c">## This next block generates the list &quot;namelist&quot;, which is a list of strings, with each</span>
        <span class="c">## element of `namelist` being a single author&#39;s name. That single author&#39;s name is encoded</span>
        <span class="c">## as a dictionary with keys &quot;first&quot;, &quot;middle&quot;, &quot;prefix&quot;, &quot;last&quot;, and &quot;suffix&quot;.</span>
        <span class="n">npersons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span>
        <span class="n">new_namelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">:</span>
            <span class="c">## The BibTeX standard states that a final author in the authors field of &quot;and others&quot;</span>
            <span class="c">## should be taken as meaning to use \textit{et al.} at the end of the author list.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;others&#39;</span> <span class="ow">in</span> <span class="n">person</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;first&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">person</span><span class="p">):</span>
                <span class="n">npersons</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">maxnames</span> <span class="o">=</span> <span class="n">npersons</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c">## From the person&#39;s name dictionary, create a string of the name in the format</span>
            <span class="c">## desired for the final BBL file.</span>
            <span class="n">formatted_name</span> <span class="o">=</span> <span class="n">namedict_to_formatted_namestr</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                                           <span class="n">use_firstname_initials</span><span class="o">=</span><span class="n">use_first_inits</span><span class="p">,</span>
                                                           <span class="n">namelist_format</span><span class="o">=</span><span class="n">namelist_format</span><span class="p">)</span>
            <span class="n">new_namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_name</span><span class="p">)</span>

        <span class="c">## Now that we have the complete list of pre-formatted names, we need to join them together</span>
        <span class="c">## into a single string that can be inserted into the template.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="n">new_namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="s">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_namelist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">&lt;=</span> <span class="n">maxnames</span><span class="p">):</span>
            <span class="c">## Make a string in which each person&#39;s name is separated by a comma, except the last name,</span>
            <span class="c">## which has a comma then &quot;and&quot; before the name.</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_namelist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;, and &#39;</span> <span class="o">+</span> <span class="n">new_namelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">&gt;</span> <span class="n">maxnames</span><span class="p">):</span>
            <span class="c">## If the number of names in the list exceeds the maximum, then truncate the list to the</span>
            <span class="c">## first &quot;minnames&quot; only, and add &quot;et al.&quot; to the end of the string giving all the names.</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_namelist</span><span class="p">[:</span><span class="n">minnames</span><span class="p">])</span> <span class="o">+</span> <span class="s">r&#39;, \textit{et al.}&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;How did you get here?&#39;</span><span class="p">)</span>

        <span class="c">## Add a tag onto the end if describing an editorlist.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nametype</span> <span class="o">==</span> <span class="s">&#39;editor&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">namestr</span> <span class="o">+=</span> <span class="s">&#39;, ed.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">namestr</span> <span class="o">+=</span> <span class="s">&#39;, eds&#39;</span>

        <span class="k">return</span><span class="p">(</span><span class="n">namestr</span><span class="p">)</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.insert_crossref_data"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.insert_crossref_data">[docs]</a>    <span class="k">def</span> <span class="nf">insert_crossref_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">fieldname</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert crossref info into a bibliography database dictionary.</span>

<span class="sd">        Loop through a bibliography database dictionary and, for each entry which has a &quot;crossref&quot;</span>
<span class="sd">        field, locate the crossref entry and insert any missing bibliographic information into the</span>
<span class="sd">        main entry&#39;s fields.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrykey : str</span>
<span class="sd">            The key of the bibliography entry to query.</span>
<span class="sd">        fieldname : str, optional</span>
<span class="sd">            The name of the field to check. If fieldname==None, then check all fields.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        foundit : bool</span>
<span class="sd">            Whether the function found a crossref for the queried field. If multiple fieldnames \</span>
<span class="sd">            were input, then foundit will be True if a crossref is located for any one of them.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">## First check that the entrykey exists.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">entrykey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">bibentry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;crossref&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
            <span class="k">return</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fieldname</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">bibentry</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>

        <span class="n">foundit</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c">## Check that the crossreferenced entry actually exists. If not, then just move on.</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;crossref&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="n">crossref_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;crossref&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: bad cross reference. Entry &quot;&#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s">&#39;&quot; refers to entry &quot;&#39;</span> <span class="o">+</span> \
                      <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;crossref&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&quot;, which doesn</span><span class="se">\&#39;</span><span class="s">t exist.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">crossref_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;crossref&#39;</span><span class="p">]][</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">foundit</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c">## What a &quot;booktitle&quot; is in the entry is normally a &quot;title&quot; in the crossref.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">crossref_keys</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;booktitle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;booktitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s">&#39;crossref&#39;</span><span class="p">]][</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
                <span class="n">foundit</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span><span class="p">(</span><span class="n">foundit</span><span class="p">)</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.write_citeextract"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_citeextract">[docs]</a>    <span class="k">def</span> <span class="nf">write_citeextract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract a sub-database from a large bibliography database, with the former containing only \</span>
<span class="sd">        those entries cited in the .aux file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filedict :  str</span>
<span class="sd">            The dictionary filenames must have keys &quot;aux&quot;,  &quot;bst&quot;, and &quot;bib&quot;.</span>
<span class="sd">        outputfile : str, optional</span>
<span class="sd">            The filename to use for writing the extracted BIB file.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">## A dict comprehension to extract only the relevant items in &quot;bibdata&quot;.</span>
        <span class="n">bibextract</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citedict</span><span class="p">}</span>
        <span class="n">export_bibfile</span><span class="p">(</span><span class="n">bibextract</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c">## =============================</span></div>
<div class="viewcode-block" id="Bibdata.write_authorextract"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_authorextract">[docs]</a>    <span class="k">def</span> <span class="nf">write_authorextract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searchname</span><span class="p">,</span> <span class="n">outputfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract a sub-database from a large bibliography database, with the former containing only \</span>
<span class="sd">        those entries citing the given author/editor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        searchname : str or dict</span>
<span class="sd">            The string or dictionary for the author&#39;s name. This can be, for example, &quot;Bugs E. Bunny&quot;</span>
<span class="sd">            or {&#39;first&#39;:&#39;Bugs&#39;, &#39;last&#39;:&#39;Bunny&#39;, &#39;middle&#39;:&#39;E&#39;}.</span>
<span class="sd">        outputfile : str, optional</span>
<span class="sd">            The filename of the extracted BIB file to write.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">searchname</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;The input search name [&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">searchname</span><span class="p">)</span> <span class="o">+</span> \
                            <span class="s">&#39;&quot;] is not a valid string.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputfile</span><span class="p">:</span>
            <span class="n">outputfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;aux&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_authorextract.bib&#39;</span>

        <span class="n">searchname</span> <span class="o">=</span> <span class="n">namestr_to_namedict</span><span class="p">(</span><span class="n">searchname</span><span class="p">)</span>
        <span class="n">nkeys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchname</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c">## Find out if any of the tokens in the search name are initials. If so, then we need to</span>
        <span class="c">## perform the search over initialized names and not full names. Save the set of booleans</span>
        <span class="c">## (one for each name part) in a dictionary to use in the search loop below.</span>
        <span class="n">name_is_initialized</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">searchname</span><span class="p">:</span>
            <span class="n">name_is_initialized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">searchname</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>

        <span class="c">## This is the dictionary we will stuff extracted entries into.</span>
        <span class="n">bibextract</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c">## count the number of entries found</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span>
            <span class="c">## Get the list of name dictionaries from the entry.</span>
            <span class="n">name_list_of_dicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;author&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_namelist</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;author&#39;</span><span class="p">)</span>
                <span class="n">name_list_of_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;authorlist&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;editor&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_namelist</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;editor&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">&#39;author&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">name_list_of_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;editorlist&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">## If the entry has both authors and editors, then just merge the two name</span>
                    <span class="c">## lists.</span>
                    <span class="n">name_list_of_dicts</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;editorlist&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">name_list_of_dicts</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c">## Compare each name dictionary in the entry with the input author&#39;s name dict.</span>
            <span class="c">## All of an author&#39;s name keys must equal an entry&#39;s name key to produce a match.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list_of_dicts</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">searchname</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]):</span> <span class="k">continue</span>

                <span class="n">key_matches</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">namekey</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">namekey</span> <span class="ow">in</span> <span class="n">searchname</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">name_is_initialized</span><span class="p">[</span><span class="n">namekey</span><span class="p">]:</span>
                            <span class="n">thisname</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">namekey</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">thisname</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">namekey</span><span class="p">]</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">thisname</span> <span class="o">==</span> <span class="n">searchname</span><span class="p">[</span><span class="n">namekey</span><span class="p">]):</span>
                            <span class="n">key_matches</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Found match in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s">&#39;&quot;: name[&#39;</span> <span class="o">+</span> <span class="n">namekey</span> <span class="o">+</span> <span class="s">&#39;] = &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="n">namekey</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key_matches</span> <span class="o">==</span> <span class="n">nkeys</span><span class="p">):</span>
                    <span class="c">#print(k, bibdata[k][&#39;author&#39;])</span>
                    <span class="n">bibextract</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">nentries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Match FULL NAME in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s">&#39;&quot;: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="n">export_bibfile</span><span class="p">(</span><span class="n">bibextract</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">)</span>

        <span class="k">return</span>

<span class="c">## ================================================================================================</span>
<span class="c">## END OF BIBDATA CLASS.</span>
<span class="c">## ================================================================================================</span>

<span class="c">## =============================</span></div></div>
<div class="viewcode-block" id="get_bibfilenames"><a class="viewcode-back" href="../bibulous.html#bibulous.get_bibfilenames">[docs]</a><span class="k">def</span> <span class="nf">get_bibfilenames</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    If the input is a filename ending in &#39;.aux&#39;, then read through the .aux file and locate the</span>
<span class="sd">    lines `\bibdata{...}` and `\bibstyle{...}` to get the filename(s) for the bibliography database</span>
<span class="sd">    and style template.</span>

<span class="sd">    If the input is a list of filenames, then assume that this is the complete list of files to</span>
<span class="sd">    use.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The &quot;auxiliary&quot; file, containing citation info, TOC info, etc.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filedict : dict</span>
<span class="sd">        A dictionary with keys &#39;bib&#39; and &#39;bst&#39;, each entry of which contains a list of filenames.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">bibfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bstfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">auxfile</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">bblfile</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">texfile</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.aux&#39;</span><span class="p">):</span>
        <span class="n">auxfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rU&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">bibdata{&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
                <span class="n">bibres</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">indx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">bibstyle{&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
                <span class="n">bstres</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">indx</span><span class="p">]</span>

        <span class="c">## Now we have the strings from the *.tex file that describing the bibliography filenames.</span>
        <span class="c">## If these are lists of filenames, then split them out.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">bibres</span><span class="p">):</span>
            <span class="n">bibres</span> <span class="o">=</span> <span class="n">bibres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>      <span class="c">## if a list of files, then split up the list pieces</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bibres</span> <span class="o">=</span> <span class="p">[</span><span class="n">bibres</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bibres</span><span class="p">:</span>
            <span class="c">## If the filename is missing the extension, then add it.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bib&#39;</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="s">&#39;.bib&#39;</span>

            <span class="c">## If the filename has a relative address, convert it to an absolute one.</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;./&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
                <span class="c">## Linux absolute paths begin with a forward slash</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;:&#39;</span><span class="p">):</span>
                <span class="c">## Windows absolute paths begin with a drive letter and a colon.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">r</span>

            <span class="n">bibfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c">## Next do the same thing for the *.bst files.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">bstres</span><span class="p">):</span>
            <span class="n">bstres</span> <span class="o">=</span> <span class="n">bstres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>      <span class="c">## if a list of files, then split up the list pieces</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bstres</span> <span class="o">=</span> <span class="p">[</span><span class="n">bstres</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bstres</span><span class="p">:</span>
            <span class="c">## If the filename is missing the extension, then add it.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bst&#39;</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="s">&#39;.bst&#39;</span>

            <span class="c">## If the filename has a relative address, convert it to an absolute one.</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;./&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
                <span class="c">## Linux absolute paths begin with a forward slash</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;:&#39;</span><span class="p">):</span>
                <span class="c">## Windows absolute paths begin with a drive letter and a colon.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">r</span>

            <span class="n">bstfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c">## Finally, normalize the file strings to work on any platform.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bibfiles</span><span class="p">)):</span>
            <span class="n">bibfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">bibfiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bstfiles</span><span class="p">)):</span>
            <span class="n">bstfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">bstfiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c">## Or if the input is only a BIB file, then go off of that.</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bib&#39;</span><span class="p">):</span>
        <span class="n">bibfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)]</span>

    <span class="c">## Or of the input is a list, then we can go through all the filenames in the list.</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="c">## All the work above was to locate the filenames from a single AUX file. However, if the</span>
        <span class="c">## input is a list of filenames, then constructing the filename dictionary is simple.</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.aux&#39;</span><span class="p">):</span> <span class="n">auxfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bib&#39;</span><span class="p">):</span> <span class="n">bibfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bst&#39;</span><span class="p">):</span> <span class="n">bstfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bbl&#39;</span><span class="p">):</span> <span class="n">bblfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.tex&#39;</span><span class="p">):</span> <span class="n">texfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">bblfile</span><span class="p">:</span>
        <span class="n">bblfile</span> <span class="o">=</span> <span class="n">auxfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.bbl&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">texfile</span> <span class="ow">and</span> <span class="n">auxfile</span><span class="p">:</span>
        <span class="n">texfile</span> <span class="o">=</span> <span class="n">auxfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.tex&#39;</span>

    <span class="c">## Now that we have the filenames, build the dictionary of BibTeX-related files.</span>
    <span class="n">filedict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibfiles</span>
    <span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bstfiles</span>
    <span class="n">filedict</span><span class="p">[</span><span class="s">&#39;tex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texfile</span>
    <span class="n">filedict</span><span class="p">[</span><span class="s">&#39;aux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxfile</span>
    <span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bbl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bblfile</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;bib files: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">bibfiles</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;bst files: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">bstfiles</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;tex file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">texfile</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;aux file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">auxfile</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;bbl file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bblfile</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">filedict</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="sentence_case"><a class="viewcode-back" href="../bibulous.html#bibulous.sentence_case">[docs]</a><span class="k">def</span> <span class="nf">sentence_case</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reduce the case of the string to lower case, except for the first character in the string, and</span>
<span class="sd">    except if any given character is at nonzero brace level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to be modified.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : str</span>
<span class="sd">        The resulting modified string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

    <span class="c">## Next we look for LaTeX commands, given by a backslash followed by a non-word character.</span>
    <span class="c">## Do not reduce those characters in the LaTeX command to lower case. To facilitate that, add</span>
    <span class="c">## one to the brace level for each of those character positions.</span>
    <span class="n">brlevel</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">r&#39;</span><span class="se">\\</span><span class="s">\w+&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">):</span>
        <span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
        <span class="n">brlevel</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">brlevel</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]]</span>

    <span class="c">## Convert the string to a character list for easy in-place modification.</span>
    <span class="n">charlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">charlist</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">brlevel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">charlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">charlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">charlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="stringsplit"><a class="viewcode-back" href="../bibulous.html#bibulous.stringsplit">[docs]</a><span class="k">def</span> <span class="nf">stringsplit</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">r&#39; |(?&lt;!</span><span class="se">\\</span><span class="s">)~&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string into tokens, taking care not to allow the separator to act unless at brace</span>
<span class="sd">    level zero.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tokens : list of str</span>
<span class="sd">        The list of tokens.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">## The item separating the name tokens can be either a space character or a tilde, if the</span>
    <span class="c">## tilde is not preceded by a backslash (in which case it instead represents an accent</span>
    <span class="c">## character and not a separator).</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c">## Record the indices of the start and end of the match.</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>

        <span class="n">ntokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ntokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ntokens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c">## Go through each match&#39;s indices and split the string at each.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">ntokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">ntokens</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c">## the end of *this* separator</span>
                <span class="c">#print(&#39;n,j=&#39;, n, j)</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nexti</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>      <span class="c">## the beginning of the *next* separator</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c">## the end of *this* separator</span>
                <span class="c">#print(&#39;n,j,nexti=&#39;, n, j, nexti)</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">nexti</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="finditer"><a class="viewcode-back" href="../bibulous.html#bibulous.finditer">[docs]</a><span class="k">def</span> <span class="nf">finditer</span><span class="p">(</span><span class="n">a_str</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A generator replacement for re.finditer() but without using regex expressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a_str : str</span>
<span class="sd">        The string to query.</span>
<span class="sd">    sub : str</span>
<span class="sd">        The substring to match to.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    start : int</span>
<span class="sd">            The start index of the match</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">a_str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">yield</span> <span class="n">start</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="namefield_to_namelist"><a class="viewcode-back" href="../bibulous.html#bibulous.namefield_to_namelist">[docs]</a><span class="k">def</span> <span class="nf">namefield_to_namelist</span><span class="p">(</span><span class="n">namefield</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nameabbrev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parse a name field (&quot;author&quot; or &quot;editor&quot;) of a BibTeX entry into a list of dicts, one for</span>
<span class="sd">    each person.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namefield : str</span>
<span class="sd">        Either the &quot;author&quot; field of a database entry or the &quot;editor&quot; field.</span>
<span class="sd">    key : str</span>
<span class="sd">        The bibliography data entry key.</span>
<span class="sd">    nameabbrev : dict</span>
<span class="sd">        The dictionary for translating names to their abbreviated forms.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namelist : list</span>
<span class="sd">        A list of dictionaries, with one dictionary for each name. Each dict has keys &quot;first&quot;,</span>
<span class="sd">        &quot;middle&quot;, &quot;prefix&quot;, &quot;last&quot;, and &quot;suffix&quot;. The &quot;last&quot; key is the only one that is required.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">namefield</span> <span class="o">=</span> <span class="n">namefield</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">namelist</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">## Look for common typos.</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\sand,\s&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: The name string in entry &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot; has &quot; and, &quot;, which is likely &#39;</span>
              <span class="s">&#39;a typo. Continuing on anyway ...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;, and&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: The name string in entry &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot; has &quot;, and&quot;, which is likely &#39;</span>
              <span class="s">&#39;a typo. Continuing on anyway ...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">nameabbrev</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">nameabbrev</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">namefield</span><span class="p">:</span> <span class="n">namefield</span> <span class="o">=</span> <span class="n">namefield</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nameabbrev</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="c">## Split the string of names into individual strings, one for each complete name. Here we</span>
    <span class="c">## can split on whitespace surround the word &quot;and&quot; so that &quot;{and}&quot; and &quot;word~and~word&quot; will</span>
    <span class="c">## not allow the split. Need to treat the case of a single author separate from that of</span>
    <span class="c">## multiple authors in order to return a single-element *list* rather than a scalar.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\sand\s&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">):</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="n">namestr_to_namedict</span><span class="p">(</span><span class="n">namefield</span><span class="p">)</span>
        <span class="n">namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namefield</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;\sand\s&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## If there are braces in the string, then we need to be careful to only allow</span>
            <span class="c">## splitting of the names when &#39; and &#39; is at brace level 0. This requires replacing</span>
            <span class="c">## re.split() with a bunch of low-level code.</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">namefield</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">separators</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">r&#39;\sand\s&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">):</span>
                <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c">## Record the indices of the start and end of the match.</span>
                    <span class="n">separators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>

            <span class="n">num_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">separators</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">separators</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">[:</span><span class="n">separators</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

            <span class="c">## Go through each match&#39;s indices and split the string at each.</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">num_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">num_names</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c">## the end of *this* separator</span>
                    <span class="c">#print(&#39;n,j=&#39;, n, j)</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">[</span><span class="n">j</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nexti</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>      <span class="c">## the beginning of the *next* separator</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c">## the end of *this* separator</span>
                    <span class="c">#print(&#39;n,j,nexti=&#39;, n, j, nexti)</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">nexti</span><span class="p">])</span>

        <span class="n">nauthors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nauthors</span><span class="p">):</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">namestr_to_namedict</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="namedict_to_formatted_namestr"><a class="viewcode-back" href="../bibulous.html#bibulous.namedict_to_formatted_namestr">[docs]</a><span class="k">def</span> <span class="nf">namedict_to_formatted_namestr</span><span class="p">(</span><span class="n">namedict</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_firstname_initials</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">namelist_format</span><span class="o">=</span><span class="s">&#39;first_name_first&#39;</span><span class="p">,</span> <span class="n">nameabbrev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a name dictionary into a formatted name string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        The name dictionary (contains a required key &quot;last&quot; and optional keys &quot;first&quot;, &quot;middle&quot;, \</span>
<span class="sd">        &quot;prefix&quot;, and &quot;suffix&quot;.</span>
<span class="sd">    options : dict, optional</span>
<span class="sd">        Includes formatting options such as</span>
<span class="sd">        &#39;use_name_ties&#39;: Whether to use &#39;~&#39; instead of spaces to tie together author initials.</span>
<span class="sd">        &#39;terse_inits&#39;: Whether to format initialized author names like &quot;RMA Azzam&quot; instead of \</span>
<span class="sd">            the default form &quot;R. M. A. Azzam&quot;.</span>
<span class="sd">        &#39;french_intials&#39;: Whether to initialize digraphs with two letters instead of the default \</span>
<span class="sd">            of one. For example, if use_french_initials==True, then &quot;Christian&quot; -&gt; &quot;Ch.&quot;, not &quot;C.&quot;.</span>
<span class="sd">        &#39;period_after_initial&#39;: Whether to include a &#39;.&#39; after the author initial.</span>
<span class="sd">    use_firstname_initials : bool</span>
<span class="sd">        Whether or not to initialize first names.</span>
<span class="sd">    namelist_format : str</span>
<span class="sd">        The type of format to use for name formatting. (&quot;first_name_first&quot;, &quot;last_name_first&quot;)</span>
<span class="sd">    nameabbrev : list of str</span>
<span class="sd">        A list of names and their abbreviations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namestr : str</span>
<span class="sd">        The formatted string of the name.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;use_name_ties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;terse_inits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;french_intials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">lastname</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;first&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span>
    <span class="n">middlename</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;middle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;suffix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;suffix&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">use_firstname_initials</span><span class="p">:</span>
        <span class="n">firstname</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">firstname</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">middlename</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">middlename</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">middlename</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;use_name_ties&#39;</span><span class="p">]:</span>
            <span class="n">middlename</span> <span class="o">=</span> <span class="n">middlename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">)</span>    <span class="c">## replace spaces with tildes</span>
            <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s">&#39;~&#39;</span> <span class="o">+</span> <span class="n">middlename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">middlename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;terse_inits&#39;</span><span class="p">]:</span>
        <span class="n">frontname</span> <span class="o">=</span> <span class="n">frontname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c">## Reconstruct the name string in the desired order for the formatted bibliography.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">namelist_format</span> <span class="o">==</span> <span class="s">&#39;first_name_first&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">prefix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">frontname</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>    <span class="c">## provide a space before last name</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">frontname</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">lastname</span> <span class="o">+</span> <span class="n">suffix</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">namelist_format</span> <span class="o">==</span> <span class="s">&#39;last_name_first&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="c">## Provide a comma before the first name.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">frontname</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span> <span class="n">frontname</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span> <span class="o">+</span> <span class="n">frontname</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">lastname</span> <span class="o">+</span> <span class="n">frontname</span> <span class="o">+</span> <span class="n">suffix</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namestr</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="initialize_name"><a class="viewcode-back" href="../bibulous.html#bibulous.initialize_name">[docs]</a><span class="k">def</span> <span class="nf">initialize_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    From an input name element (first, middle, prefix, last, or suffix) , convert it to its</span>
<span class="sd">    initials.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name element to be converted.</span>
<span class="sd">    options : dict, optional</span>
<span class="sd">        Includes formatting options such as</span>
<span class="sd">        &#39;use_name_ties&#39;: Whether to use &#39;~&#39; instead of spaces to tie together author initials.</span>
<span class="sd">        &#39;terse_inits&#39;: Whether to format initialized author names like &quot;RMA Azzam&quot; instead of \</span>
<span class="sd">            the default form &quot;R. M. A. Azzam&quot;.</span>
<span class="sd">        &#39;french_intials&#39;: Whether to initialize digraphs with two letters instead of the default \</span>
<span class="sd">            of one. For example, if use_french_initials==True, then &quot;Christian&quot; -&gt; &quot;Ch.&quot;, not &quot;C.&quot;.</span>
<span class="sd">        &#39;period_after_initial&#39;: Whether to include a &#39;.&#39; after the author initial.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_name : str</span>
<span class="sd">        The name element converted to its initials form.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;french_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;terse_inits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c">## Go through the author&#39;s name elements and truncate the first and middle names to their</span>
    <span class="c">## initials. If using French initials, then a hyphenated name produces hyphenated initials</span>
    <span class="c">## (for example &quot;Jean-Paul&quot; -&gt; &quot;J.-P.&quot; and not &quot;J.&quot;), and a name beginning with a digraph</span>
    <span class="c">## produces a digraph initial, so that Philippe -&gt; Ph. (not P.), and Christian -&gt; Ch. (not C.).</span>
    <span class="n">digraphs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Ch&#39;</span><span class="p">,</span><span class="s">&#39;Gn&#39;</span><span class="p">,</span><span class="s">&#39;Ll&#39;</span><span class="p">,</span><span class="s">&#39;Ph&#39;</span><span class="p">,</span><span class="s">&#39;Ss&#39;</span><span class="p">,</span><span class="s">&#39;Ch&#39;</span><span class="p">,</span><span class="s">&#39;Ph&#39;</span><span class="p">,</span><span class="s">&#39;Th&#39;</span><span class="p">)</span>
    <span class="n">period</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>

    <span class="c">## Split the name by spaces (primarily used for middle name strings, which may have multiple</span>
    <span class="c">## names in them), and remove any empty list elements produced by the split.</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">))</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">nametoken</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nametoken</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nametoken</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">):</span> <span class="k">continue</span>

        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">nametoken</span><span class="p">):</span>
            <span class="c">## If the name is hyphenated, then initialize the hyphenated parts of it, and assemble</span>
            <span class="c">## the result by combining initials with the hyphens. That is, &quot;Chein-Ing&quot; -&gt; &quot;C.-I.&quot;.</span>
            <span class="n">pieces</span> <span class="o">=</span> <span class="n">nametoken</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">initialize_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pieces</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## If the token already ends in a period then it&#39;s might already be an initial, but</span>
            <span class="c">## only if it has length 2. Otherwise you still need to truncate it.</span>
            <span class="c">## If the name only has one character in it, then treat it as a full name that doesn&#39;t</span>
            <span class="c">## need initializing.</span>
            <span class="k">if</span> <span class="n">nametoken</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametoken</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametoken</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">period</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametoken</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;french_initials&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nametoken</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digraphs</span><span class="p">):</span>
                    <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametoken</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">period</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametoken</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">period</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametoken</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;terse_inits&#39;</span><span class="p">]:</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">period</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Initializer input [&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;] --&gt; output [&#39;</span> <span class="o">+</span> <span class="n">newname</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="get_delim_levels"><a class="viewcode-back" href="../bibulous.html#bibulous.get_delim_levels">[docs]</a><span class="k">def</span> <span class="nf">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">),</span> <span class="n">operator</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a list of level numbers for each character in a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to characterize.</span>
<span class="sd">    ldelim : str</span>
<span class="sd">        The left-hand-side delimiter.</span>
<span class="sd">    rdelim : str</span>
<span class="sd">        The right-hand-side delimiter.</span>
<span class="sd">    is_regex : bool</span>
<span class="sd">        Whether the delimiters are expressed as regular expressions or as simple strings.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    oplevels : list of ints</span>
<span class="sd">        A list giving the operator delimiter level (or &quot;brace level&quot; if no operator is given) of \</span>
<span class="sd">        each character in the string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">oplevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c">## operator level</span>
    <span class="n">brlevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c">## brace level</span>

    <span class="c">## Locate the left-delimiters and increment the level each time we find one.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">oplevels</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">delims</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">operator</span><span class="p">):</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">operator</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;o&#39;</span><span class="p">)</span>       <span class="c">## add an &quot;operator&quot; marker to the stack</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span>       <span class="c">## add a &quot;brace level&quot; marker to the stack</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">delims</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span> <span class="n">oplevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">brlevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">oplevels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">brlevels</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<span class="k">def</span> <span class="nf">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">levels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A debugging tool for showing delimiter levels and the input string next to one another.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c">## counter for the character ending a line</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">q</span><span class="p">:</span><span class="n">q</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)])[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">levels</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="c">## ===================================</span>
<div class="viewcode-block" id="get_quote_levels"><a class="viewcode-back" href="../bibulous.html#bibulous.get_quote_levels">[docs]</a><span class="k">def</span> <span class="nf">get_quote_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a list which gives the &quot;quotation level&quot; of each character in the string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to analyze.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alevels : list</span>
<span class="sd">        The double-quote-level for (``,&#39;&#39;) pairs in the string.</span>
<span class="sd">    blevels : list</span>
<span class="sd">        The single-quote-level for (`,&#39;) pairs in the string.</span>
<span class="sd">    clevels : list</span>
<span class="sd">        The neutral-quote-level for (&quot;,&quot;) pairs in the string.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    When using double-quotes, it is easy to break the parser, so they should be used only sparingly.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">alevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c">## double-quote level</span>
    <span class="n">blevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c">## single-quote level</span>
    <span class="n">clevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c">## neutral-quote level</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;`&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="c">## Note: the &#39;\\&#39; case here is for detecting a grave accent markup.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;``&#39;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>       <span class="c">## add a double-quote marker to the stack</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;`&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;()[]{}&quot;:;,&lt;&gt;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="c">## The trouble with single-quotes is the clash with apostrophes. So, only increment</span>
                <span class="c">## the single-quote counter if we think it is the start of a quote (not immediately</span>
                <span class="c">## preceded by a non-whitespace character).</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span>       <span class="c">## add a single-quote marker to the stack</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">blevels</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">clevels</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="c">## Note: the &#39;\\&#39; case here is for detecting an accent markup.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&#39;&#39;&quot;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c">## remove double-quote marker from the stack</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c">## remove single-quote marker from the stack</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="c">## Note: the &#39;\\&#39; here case is for not detecting an umlaut markup.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>

        <span class="n">alevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">blevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">clevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: found mismatched &quot;``&quot;...&quot;&#39;&#39;&quot; quote pairs in the input string &quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> \
              <span class="s">&#39;&quot;. Ignoring the problem and continuing on ...&#39;</span><span class="p">)</span>
        <span class="n">alevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: found mismatched &quot;`&quot;...&quot;</span><span class="se">\&#39;</span><span class="s">&quot; quote pairs in the input string &quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> \
              <span class="s">&#39;&quot;. Ignoring the problem and continuing on ...&#39;</span><span class="p">)</span>
        <span class="n">blevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: found mismatched &#39;&quot;&#39;...&#39;&quot;&#39; quote pairs in the input string &quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> \
              <span class="s">&#39;&quot;. Ignoring the problem and continuing on ...&#39;</span><span class="p">)</span>
        <span class="n">clevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">alevels</span><span class="p">)</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">blevels</span><span class="p">)</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">clevels</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">alevels</span><span class="p">,</span> <span class="n">blevels</span><span class="p">,</span> <span class="n">clevels</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="splitat"><a class="viewcode-back" href="../bibulous.html#bibulous.splitat">[docs]</a><span class="k">def</span> <span class="nf">splitat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ilist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string at locations given by a list of indices.</span>

<span class="sd">    This can be used more flexibly than Python&#39;s native string split() function, when the character</span>
<span class="sd">    you are splitting on is not always a valid splitting location.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>
<span class="sd">    ilist : list</span>
<span class="sd">        The list of string index locations at which to split the string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slist : list of str</span>
<span class="sd">        The list of split substrings.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    s = splitat(&#39;here.but.not.here&#39;, [4,8])</span>
<span class="sd">    &gt;&gt;&gt; [&#39;here&#39;, &#39;but&#39;, &#39;not.here&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">numsplit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ilist</span><span class="p">)</span>
    <span class="n">slist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ilist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c">## If the function is being asked to &quot;split&quot; at the first character, then just truncate.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ilist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ilist</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">numsplit</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c">## If the function is being asked to &quot;split&quot; at the last character, then just truncate.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ilist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ilist</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">numsplit</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c">## If truncation has removed all of the &quot;splitting&quot; locations from the list, then return.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numsplit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">ilist</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ilist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ilist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ilist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsplit</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="c">#print(n, start, end)</span>
            <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ilist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">slist</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="multisplit"><a class="viewcode-back" href="../bibulous.html#bibulous.multisplit">[docs]</a><span class="k">def</span> <span class="nf">multisplit</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seps</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string using more than one separator.</span>

<span class="sd">    Copied from http://stackoverflow.com/questions/1059559/python-strings-split-with-multiple-separators.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>
<span class="sd">    sep : list of str</span>
<span class="sd">        The list of separators.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res : list</span>
<span class="sd">        The list of split substrings.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">:</span>
        <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">seq</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="enwrap_nested_string"><a class="viewcode-back" href="../bibulous.html#bibulous.enwrap_nested_string">[docs]</a><span class="k">def</span> <span class="nf">enwrap_nested_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">),</span> <span class="n">odd_operator</span><span class="o">=</span><span class="s">r&#39;\textbf&#39;</span><span class="p">,</span> <span class="n">even_operator</span><span class="o">=</span><span class="s">r&#39;\textrm&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will return the input string if it finds there</span>
<span class="sd">    are no nested operators inside (i.e. when the number of delimiters found is &lt; 2).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string whose nested operators are to be modified.</span>
<span class="sd">    delims : tuple of two strings</span>
<span class="sd">        The left and right delimiters for all matches.</span>
<span class="sd">    odd_operator : str</span>
<span class="sd">        The nested operator (applied to the left of the delimiter) currently used within string &quot;s&quot;.</span>
<span class="sd">    even_operator : str</span>
<span class="sd">        The operator used to replace the currently used one for all even nesting levels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : str</span>
<span class="sd">        The modified string.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">odd_operator</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">oplevels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delims</span><span class="p">,</span> <span class="n">odd_operator</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">oplevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: found mismatched &quot;{&quot;,&quot;}&quot; brace pairs in the input string. &#39;</span>
              <span class="s">&#39;Ignoring the problem and continuing on ...&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">## In the operator queue, we replace all even-numbered levels while leaving all odd-numbered</span>
    <span class="c">## levels alone. Recall that &quot;oplevels&quot; encodes the position of the *delimiter* and not the</span>
    <span class="c">## position of where the operator starts.</span>
    <span class="n">maxlevels</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">oplevels</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">maxlevels</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">## Select only even levels starting at 2. &quot;q&quot; is a counter for the number of substr</span>
    <span class="c">## replacements.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_operator</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">even_operator</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oplevels</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c">## Any place we see a transition from one level lower to this level is a substr we want</span>
            <span class="c">## to replace. The &quot;shift&quot; used here is to compensate for changes in the length of the</span>
            <span class="c">## string due to differences in length between the input operator and output.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">oplevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="c">#print(i, level, oplevels[i-1], s, s[:i-len(odd_operator)], s[i:])</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">odd_operator</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">shift</span><span class="p">)]</span> <span class="o">+</span> <span class="n">even_operator</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">shift</span><span class="p">):]</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="enwrap_nested_quotes"><a class="viewcode-back" href="../bibulous.html#bibulous.enwrap_nested_quotes">[docs]</a><span class="k">def</span> <span class="nf">enwrap_nested_quotes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find nested quotes within strings and, if necessary, replace them with the proper nesting</span>
<span class="sd">    (i.e. outer quotes use ``...&#39;&#39; while inner quotes use `...&#39;).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to modify.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : str</span>
<span class="sd">        The new string in which nested quotes have been properly reformatted.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">## NOTE: There is quite a lot going on in this function, so it may help future development</span>
    <span class="c">## to write some of this work into subroutines.</span>

    <span class="c">## First check for cases where parsing is going to be very complicated. For now, we should just</span>
    <span class="c">## flag these cases to inform the user that they need to modify the source to tell the parser</span>
    <span class="c">## what they want to do.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&quot;```&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&quot;&#39;&#39;&#39;&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the input string [&quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;&quot;] contains multiple unseparated quote characters. &#39;</span>
              <span class="s">&#39;Bibulous cannot unnest the single and double quotes from this set, so the &#39;</span>
              <span class="s">&#39;separate quotations must be physically separated like ``{\:}`, for example. &#39;</span>
              <span class="s">&#39;Ignoring the quotation marks and continuing ...&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">## Note that a backtick preceded by a backslash, an explamation point, or a question mark,</span>
    <span class="c">## indicates LaTeX markup for a grave accent, an inverted explamation point, and an inverted</span>
    <span class="c">## question mark, respectively.</span>
    <span class="c">#adelims = (&#39;``&#39;,&quot;&#39;&#39;&quot;)</span>
    <span class="n">anum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&#39;(?&lt;!\!\?</span><span class="se">\\</span><span class="s">)``&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="c">#bdelims = (&#39;`&#39;,&quot;&#39;&quot;)</span>
    <span class="n">bnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&#39;(?&lt;!\!\?</span><span class="se">\\</span><span class="s">)`&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="c">#cdelim = &#39;&quot;&#39;</span>
    <span class="n">cnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)&quot;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">anum</span> <span class="o">+</span> <span class="n">bnum</span> <span class="o">+</span> <span class="n">cnum</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">## Get the lists describing the quote nesting.</span>
    <span class="p">(</span><span class="n">alevels</span><span class="p">,</span> <span class="n">blevels</span><span class="p">,</span> <span class="n">clevels</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_quote_levels</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">## First, we look at the quote stack and replace *all* quote pairs with \enquote{...}. When</span>
    <span class="c">## done, we can use `enwrap_nested_string()` to replace the odd and even instances of</span>
    <span class="c">## \enquote{} with different quotation markers, depending on locale. `q` is the amount of</span>
    <span class="c">## shift between indices in the current string and those in the source string.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">r&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">r&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c">## This is a transition down in level. Add &quot;}&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;}&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c">## Do the same thing for single quotes.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">r&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">r&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c">## This is a transition down in level. Add &quot;}&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;}&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>

        <span class="c">## Do the same thing for neutral quotes.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">r&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">r&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c">## This is a transition down in level. Add &quot;}&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;}&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>

    <span class="c">## Next, we determine the nesting levels of quotations.</span>
    <span class="n">qlevels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">),</span> <span class="s">r&#39;\enquote&#39;</span><span class="p">)</span>

    <span class="c">## Finally, replace odd levels of quotation with &quot;``&quot; and even levels with &quot;`&quot;.</span>
    <span class="c">## TODO: This approach is the American convention. Need to generalize this behavior for British</span>
    <span class="c">## convention, and, even more broadly, to all locale-dependent quotation mark behavior. For</span>
    <span class="c">## now let&#39;s just try to get the American version working.</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">odd_operators</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;``&quot;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
    <span class="n">even_operators</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;`&quot;</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">qlevels</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qlevels</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">continue</span>

        <span class="c">## Any place we see a transition from one level lower to this level is a substr we want</span>
        <span class="c">## to replace. The shift &quot;t&quot; used here is to compensate for changes in the length of the</span>
        <span class="c">## string due to differences in length between the input operator and output. Also,</span>
        <span class="c">## if we are about to substitute in a quote character (or two, in the case of LaTeX</span>
        <span class="c">## double quotes), then we need to be careful to look in front and see if the quotes butt</span>
        <span class="c">## up against one another, in which case we need to add a small space. For example, LaTeX</span>
        <span class="c">## will interpret &#39;&#39;&#39; as a double ending quote followed by a single ending quote, even if</span>
        <span class="c">## we meant it to be the other way around. The space &quot;\:&quot; will remove the ambiguity.</span>

        <span class="c">## There is quite a lot going on in this loop, so it may help future work to replace some</span>
        <span class="c">## of the operations here with subroutines.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="s">r&#39;\:&#39;</span> <span class="o">+</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="s">r&#39;\:&#39;</span> <span class="o">+</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;r\enquote{&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="s">r&#39;\:&#39;</span> <span class="o">+</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">r&#39;\enquote{&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="s">r&#39;\:&#39;</span> <span class="o">+</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="purify_string"><a class="viewcode-back" href="../bibulous.html#bibulous.purify_string">[docs]</a><span class="k">def</span> <span class="nf">purify_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Remove the LaTeX-based formatting elements from a string so that a sorting function can use \</span>
<span class="sd">    alphanumerical sorting on the string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to &quot;purify&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p : str</span>
<span class="sd">        The &quot;purified&quot; string.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Currently `purify_string()` does not allow LaTeX markup such as \&#39;i to refer to the Unicode</span>
<span class="sd">    character which is correctly written as \&#39;\i. Add functionality to allow that?</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">):</span>
        <span class="c">## Remove braces if present.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c">## Convert any LaTeX character encodings directly to their unicode equivalents.</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">latex_to_utf8</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c">## Next we look for LaTeX commands. LaTeX variables will have the form &quot;\variable&quot; followed</span>
    <span class="c">## by either whitespace, &#39;{&#39;, or &#39;}&#39;. A function will have the form &quot;\functionname{...}&quot;</span>
    <span class="c">## where the ellipsis can be anything.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;</span><span class="se">\\</span><span class="s">\w+&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="c">## Finally, remove the braces used for LaTeX commands. We can&#39;t just replace &#39;{&#39; and &#39;}&#39;</span>
    <span class="c">## wholesale, since the syntax allows &#39;\{&#39; and &#39;\}&#39; to produce text braces. So first we</span>
    <span class="c">## remove the command braces, and then we swap &#39;\{&#39; for &#39;{&#39; etc at the end.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">){&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)}&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">{&#39;</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">}&#39;</span><span class="p">,</span> <span class="s">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c">## =============================</span>
<span class="c">## I think that we can get rid of the &quot;u&quot; in front of the strings now that we are using</span>
<span class="c">## &quot;from __future__ import unicode_literals&quot;.</span></div>
<div class="viewcode-block" id="latex_to_utf8"><a class="viewcode-back" href="../bibulous.html#bibulous.latex_to_utf8">[docs]</a><span class="k">def</span> <span class="nf">latex_to_utf8</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Translate LaTeX-markup special characters to their Unicode equivalents.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to translate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : str</span>
<span class="sd">        The translated version of the input.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">## Note that the code below uses replace() loops rather than a translation table, since the</span>
    <span class="c">## latter only supports one-to-one translation, whereas something more flexible is needed</span>
    <span class="c">## here. There is a substantial</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">## First, some easy replacements.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\$&#39;</span><span class="p">:</span><span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="s">r&#39;\%&#39;</span><span class="p">:</span><span class="s">&#39;%&#39;</span><span class="p">,</span> <span class="s">r&#39;\_&#39;</span><span class="p">:</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">r&#39;\&amp;&#39;</span><span class="p">:</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s">r&#39;\#&#39;</span><span class="p">:</span><span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="s">r&#39;!`&#39;</span><span class="p">:</span><span class="s">&#39;¡&#39;</span><span class="p">,</span> <span class="s">r&#39;?`&#39;</span><span class="p">:</span><span class="s">&#39;¿&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## If there are any double backslashes, place some braces around them to prevent something like</span>
    <span class="c">## &quot;\\aa&quot; from getting interpreted as a backslash plus &quot;\aa&quot;. This makes the string easier to</span>
    <span class="c">## parse and does no harm.</span>
    <span class="k">if</span> <span class="s">r&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">r&#39;{</span><span class="se">\\</span><span class="s">}&#39;</span><span class="p">)</span>

    <span class="c">## First identify all the LaTeX special characters in the string, then replace them all with</span>
    <span class="c">## their Unicode equivalents. (This is to make sure that they alphabetize correctly for</span>
    <span class="c">## sorting.)</span>
    <span class="c">##     The translation dictionary below uses single-letter accent commands, such as \u{g}.</span>
    <span class="c">## These commands are one of (r&#39;\b&#39;, r&#39;\c&#39;, r&#39;\d&#39;, r&#39;\H&#39;, r&#39;\k&#39;, r&#39;\r&#39;, r&#39;\u&#39;, r&#39;\v&#39;), followed</span>
    <span class="c">## by an open brace, a single character, and a closed brace. These replacements are done first</span>
    <span class="c">## because some of the special characters use &#39;\i&#39;, which would otherwise get replaced by the</span>
    <span class="c">## &quot;dotless i&quot; Unicode character, and so the replacement dictionary here would not detect</span>
    <span class="c">## the proper LaTeX code for it.</span>

    <span class="c">## First, characters with a cedilla or comma below.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;\c&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\c{C}&#39;</span><span class="p">:</span><span class="s">&#39;Ç&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c C}&#39;</span><span class="p">:</span><span class="s">&#39;Ç&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{c}&#39;</span><span class="p">:</span><span class="s">&#39;ç&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c c}&#39;</span><span class="p">:</span><span class="s">&#39;ç&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{E}&#39;</span><span class="p">:</span><span class="s">&#39;Ȩ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c E}&#39;</span><span class="p">:</span><span class="s">&#39;Ȩ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{e}&#39;</span><span class="p">:</span><span class="s">&#39;ȩ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c e}&#39;</span><span class="p">:</span><span class="s">&#39;ȩ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{G}&#39;</span><span class="p">:</span><span class="s">&#39;Ģ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c G}&#39;</span><span class="p">:</span><span class="s">&#39;Ģ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{g}&#39;</span><span class="p">:</span><span class="s">&#39;ģ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c g}&#39;</span><span class="p">:</span><span class="s">&#39;ģ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{K}&#39;</span><span class="p">:</span><span class="s">&#39;Ķ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c K}&#39;</span><span class="p">:</span><span class="s">&#39;Ķ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{k}&#39;</span><span class="p">:</span><span class="s">&#39;ķ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c k}&#39;</span><span class="p">:</span><span class="s">&#39;ķ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{L}&#39;</span><span class="p">:</span><span class="s">&#39;Ļ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c L}&#39;</span><span class="p">:</span><span class="s">&#39;Ļ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{l}&#39;</span><span class="p">:</span><span class="s">&#39;ļ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c l}&#39;</span><span class="p">:</span><span class="s">&#39;ļ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{N}&#39;</span><span class="p">:</span><span class="s">&#39;Ņ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c N}&#39;</span><span class="p">:</span><span class="s">&#39;Ņ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{n}&#39;</span><span class="p">:</span><span class="s">&#39;ņ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c n}&#39;</span><span class="p">:</span><span class="s">&#39;ņ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{R}&#39;</span><span class="p">:</span><span class="s">&#39;Ŗ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c R}&#39;</span><span class="p">:</span><span class="s">&#39;Ŗ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{r}&#39;</span><span class="p">:</span><span class="s">&#39;ŗ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c r}&#39;</span><span class="p">:</span><span class="s">&#39;ŗ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{S}&#39;</span><span class="p">:</span><span class="s">&#39;Ş&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c S}&#39;</span><span class="p">:</span><span class="s">&#39;Ş&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{s}&#39;</span><span class="p">:</span><span class="s">&#39;ş&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c s}&#39;</span><span class="p">:</span><span class="s">&#39;ş&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\c{T}&#39;</span><span class="p">:</span><span class="s">&#39;Ţ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c T}&#39;</span><span class="p">:</span><span class="s">&#39;Ţ&#39;</span><span class="p">,</span> <span class="s">r&#39;\c{t}&#39;</span><span class="p">:</span><span class="s">&#39;ţ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\c t}&#39;</span><span class="p">:</span><span class="s">&#39;ţ&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Characters with breve above. Note that the &quot;\u&quot; is problematic when &quot;unicode_literals&quot; is</span>
    <span class="c">## turned on via &quot;from __future__ import unicode_literals&quot;. Thus, in the block below, rather</span>
    <span class="c">## than raw strings with single backslashes, we have to use double-backslashes.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">u&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">u{A}&#39;</span><span class="p">:</span><span class="s">&#39;Ă&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u A}&#39;</span><span class="p">:</span><span class="s">&#39;Ă&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{a}&#39;</span><span class="p">:</span><span class="s">&#39;ă&#39;</span><span class="p">,</span>  <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u a}&#39;</span><span class="p">:</span><span class="s">&#39;ă&#39;</span><span class="p">,</span>
                 <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{E}&#39;</span><span class="p">:</span><span class="s">&#39;Ĕ&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u E}&#39;</span><span class="p">:</span><span class="s">&#39;Ĕ&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{e}&#39;</span><span class="p">:</span><span class="s">&#39;ĕ&#39;</span><span class="p">,</span>  <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u e}&#39;</span><span class="p">:</span><span class="s">&#39;ĕ&#39;</span><span class="p">,</span>
                 <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{G}&#39;</span><span class="p">:</span><span class="s">&#39;Ğ&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u G}&#39;</span><span class="p">:</span><span class="s">&#39;Ğ&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{g}&#39;</span><span class="p">:</span><span class="s">&#39;ğ&#39;</span><span class="p">,</span>  <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u g}&#39;</span><span class="p">:</span><span class="s">&#39;ğ&#39;</span><span class="p">,</span>
                 <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{I}&#39;</span><span class="p">:</span><span class="s">&#39;Ĭ&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u I}&#39;</span><span class="p">:</span><span class="s">&#39;Ĭ&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{\i}&#39;</span><span class="p">:</span><span class="s">&#39;ĭ&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u\i}&#39;</span><span class="p">:</span><span class="s">&#39;ĭ&#39;</span><span class="p">,</span>
                 <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{O}&#39;</span><span class="p">:</span><span class="s">&#39;Ŏ&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u O}&#39;</span><span class="p">:</span><span class="s">&#39;Ŏ&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{o}&#39;</span><span class="p">:</span><span class="s">&#39;ŏ&#39;</span><span class="p">,</span>  <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u o}&#39;</span><span class="p">:</span><span class="s">&#39;ŏ&#39;</span><span class="p">,</span>
                 <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{U}&#39;</span><span class="p">:</span><span class="s">&#39;Ŭ&#39;</span><span class="p">,</span> <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u U}&#39;</span><span class="p">:</span><span class="s">&#39;Ŭ&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">u{u}&#39;</span><span class="p">:</span><span class="s">&#39;ŭ&#39;</span><span class="p">,</span>  <span class="s">&#39;{</span><span class="se">\\</span><span class="s">u u}&#39;</span><span class="p">:</span><span class="s">&#39;ŭ&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Characters with an ogonek.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;\k&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\k{A}&#39;</span><span class="p">:</span><span class="s">&#39;Ą&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k A}&#39;</span><span class="p">:</span><span class="s">&#39;Ą&#39;</span><span class="p">,</span> <span class="s">r&#39;\k{a}&#39;</span><span class="p">:</span><span class="s">&#39;ą&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k a}&#39;</span><span class="p">:</span><span class="s">&#39;ą&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\k(E}&#39;</span><span class="p">:</span><span class="s">&#39;Ę&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k E}&#39;</span><span class="p">:</span><span class="s">&#39;Ę&#39;</span><span class="p">,</span> <span class="s">r&#39;\k{e}&#39;</span><span class="p">:</span><span class="s">&#39;ę&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k e}&#39;</span><span class="p">:</span><span class="s">&#39;ę&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\k{I}&#39;</span><span class="p">:</span><span class="s">&#39;Į&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k I}&#39;</span><span class="p">:</span><span class="s">&#39;Į&#39;</span><span class="p">,</span> <span class="s">r&#39;\k{i}&#39;</span><span class="p">:</span><span class="s">&#39;į&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k i}&#39;</span><span class="p">:</span><span class="s">&#39;į&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\k{O}&#39;</span><span class="p">:</span><span class="s">&#39;Ǫ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k O}&#39;</span><span class="p">:</span><span class="s">&#39;Ǫ&#39;</span><span class="p">,</span> <span class="s">r&#39;\k{o}&#39;</span><span class="p">:</span><span class="s">&#39;ǫ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k o}&#39;</span><span class="p">:</span><span class="s">&#39;ǫ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\k{U}&#39;</span><span class="p">:</span><span class="s">&#39;Ų&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k U}&#39;</span><span class="p">:</span><span class="s">&#39;Ų&#39;</span><span class="p">,</span> <span class="s">r&#39;\k{u}&#39;</span><span class="p">:</span><span class="s">&#39;ų&#39;</span><span class="p">,</span> <span class="s">r&#39;{\k u}&#39;</span><span class="p">:</span><span class="s">&#39;ų&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Characters with hachek.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;\v&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\v{C}&#39;</span><span class="p">:</span><span class="s">&#39;Č&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v C}&#39;</span><span class="p">:</span><span class="s">&#39;Č&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{c}&#39;</span><span class="p">:</span><span class="s">&#39;č&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v c}&#39;</span><span class="p">:</span><span class="s">&#39;č&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{D}&#39;</span><span class="p">:</span><span class="s">&#39;Ď&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v D}&#39;</span><span class="p">:</span><span class="s">&#39;Ď&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{d}&#39;</span><span class="p">:</span><span class="s">&#39;ď&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v d}&#39;</span><span class="p">:</span><span class="s">&#39;ď&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{E}&#39;</span><span class="p">:</span><span class="s">&#39;Ě&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v E}&#39;</span><span class="p">:</span><span class="s">&#39;Ě&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{e}&#39;</span><span class="p">:</span><span class="s">&#39;ě&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v e}&#39;</span><span class="p">:</span><span class="s">&#39;ě&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{L}&#39;</span><span class="p">:</span><span class="s">&#39;Ľ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v L}&#39;</span><span class="p">:</span><span class="s">&#39;Ľ&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{l}&#39;</span><span class="p">:</span><span class="s">&#39;ľ&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v l}&#39;</span><span class="p">:</span><span class="s">&#39;ľ&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{N}&#39;</span><span class="p">:</span><span class="s">&#39;Ň&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v N}&#39;</span><span class="p">:</span><span class="s">&#39;Ň&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{n}&#39;</span><span class="p">:</span><span class="s">&#39;ň&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v n}&#39;</span><span class="p">:</span><span class="s">&#39;ň&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{R}&#39;</span><span class="p">:</span><span class="s">&#39;Ř&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v R}&#39;</span><span class="p">:</span><span class="s">&#39;Ř&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{r}&#39;</span><span class="p">:</span><span class="s">&#39;ř&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v r}&#39;</span><span class="p">:</span><span class="s">&#39;ř&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{S}&#39;</span><span class="p">:</span><span class="s">&#39;Š&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v S}&#39;</span><span class="p">:</span><span class="s">&#39;Š&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{s}&#39;</span><span class="p">:</span><span class="s">&#39;š&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v s}&#39;</span><span class="p">:</span><span class="s">&#39;š&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{T}&#39;</span><span class="p">:</span><span class="s">&#39;Ť&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v T}&#39;</span><span class="p">:</span><span class="s">&#39;Ť&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{t}&#39;</span><span class="p">:</span><span class="s">&#39;ť&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v t}&#39;</span><span class="p">:</span><span class="s">&#39;ť&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{Z}&#39;</span><span class="p">:</span><span class="s">&#39;Ž&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v Z}&#39;</span><span class="p">:</span><span class="s">&#39;Ž&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{z}&#39;</span><span class="p">:</span><span class="s">&#39;ž&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v z}&#39;</span><span class="p">:</span><span class="s">&#39;ž&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{H}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u021E</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v H}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u021E</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{h}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u021F</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v h}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u021F</span><span class="s">&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{A}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01CD</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v A}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01CD</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{a}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01CE</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v a}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01CE</span><span class="s">&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{I}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01CF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v I}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01CF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{\i}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D0</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v \i}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D0</span><span class="s">&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{O}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D1</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v O}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D1</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{o}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D2</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v o}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D2</span><span class="s">&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{U}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D3</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v U}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D3</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{u}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D4</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v u}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01D4</span><span class="s">&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{G}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E6</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v G}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E6</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{g}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E7</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v g}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E7</span><span class="s">&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;\v{K}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E8</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v K}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E8</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\v{k}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E9</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;{\v k}&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\u01E9</span><span class="s">&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;\H&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\H{O}&#39;</span><span class="p">:</span><span class="s">u&#39;Ő&#39;</span><span class="p">,</span>  <span class="s">r&#39;\H{o}&#39;</span><span class="p">:</span><span class="s">u&#39;ő&#39;</span><span class="p">,</span>  <span class="s">r&#39;\H{U}&#39;</span><span class="p">:</span><span class="s">u&#39;Ű&#39;</span><span class="p">,</span>  <span class="s">r&#39;\H{u}&#39;</span><span class="p">:</span><span class="s">u&#39;ű&#39;</span><span class="p">,</span>
                 <span class="s">r&#39;{\H O}&#39;</span><span class="p">:</span><span class="s">u&#39;Ő&#39;</span><span class="p">,</span> <span class="s">r&#39;{\H o}&#39;</span><span class="p">:</span><span class="s">u&#39;ő&#39;</span><span class="p">,</span> <span class="s">r&#39;{\H U}&#39;</span><span class="p">:</span><span class="s">u&#39;Ű&#39;</span><span class="p">,</span> <span class="s">r&#39;{\H u}&#39;</span><span class="p">:</span><span class="s">u&#39;ű&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Characters with a ring above.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">r&#39;\r&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\r{U}&#39;</span><span class="p">:</span><span class="s">u&#39;Ů&#39;</span><span class="p">,</span> <span class="s">r&#39;{\r U}&#39;</span><span class="p">:</span><span class="s">u&#39;Ů&#39;</span><span class="p">,</span> <span class="s">r&#39;\r{u}&#39;</span><span class="p">:</span><span class="s">u&#39;ů&#39;</span><span class="p">,</span> <span class="s">r&#39;{\r u}&#39;</span><span class="p">:</span><span class="s">u&#39;ů&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Now let&#39;s do the straightforward accent characters.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\`A&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C1</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`a&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E0</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;A&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C1</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;a&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E1</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~A&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C3</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^a&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E2</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;A&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C4</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~a&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E3</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\&quot;a&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E4</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`E&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C8</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;E&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C9</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`e&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E8</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^E&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CA</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;e&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E9</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;E&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CB</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^e&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EA</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\`I&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CC</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;e&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EB</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;I&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CD</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`\i&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EC</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^I&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CE</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;\i&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00ED</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;I&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^\i&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EE</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~N&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D1</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;\i&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`O&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D2</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~n&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F1</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;O&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D3</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`o&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F2</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^O&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D4</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;o&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F3</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~O&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D5</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^o&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F4</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;O&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D6</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~o&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F5</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\&quot;o&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F6</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`U&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D9</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;U&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DA</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`u&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F9</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^U&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DB</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;u&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FA</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;U&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DC</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^u&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FB</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;Y&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DD</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;u&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FC</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;y&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FD</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;y&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FF</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\=A&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0100</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\=a&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0101</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;C&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0106</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;c&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0107</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^C&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0108</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^c&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0109</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.C&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u010A</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.c&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u010B</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\=E&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0112</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\=e&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0113</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.E&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0116</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.e&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0117</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^G&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u011C</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^g&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u011D</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.G&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0120</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.g&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0121</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^H&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0124</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^h&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0125</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\~I&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0128</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~\i&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0129</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\=I&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u012A</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\=\i&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u012B</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.I&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0130</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^J&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0134</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^\j&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0135</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;L&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0139</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;N&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0143</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;n&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0144</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\=O&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u014C</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\=o&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u014D</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;R&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0154</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;r&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0155</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;S&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u015A</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;s&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u015B</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\~U&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0168</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~u&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0169</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\=U&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u016A</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\=u&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u016B</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^W&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0174</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^w&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0175</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^Y&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0176</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^y&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0177</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;Z&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0179</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;z&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u017A</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\.Z&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u017B</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.z&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u017C</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\`Y&#39;</span><span class="p">:</span><span class="s">u&#39;Ỳ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\`y&#39;</span><span class="p">:</span><span class="s">u&#39;ỳ&#39;</span><span class="p">,</span>       <span class="s">r&quot;\&#39;K&quot;</span><span class="p">:</span><span class="s">u&#39;Ḱ&#39;</span><span class="p">,</span>      <span class="s">r&quot;\&#39;k&quot;</span><span class="p">:</span><span class="s">u&#39;ḱ&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;l&quot;</span><span class="p">:</span><span class="s">u&#39;ĺ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\^A&#39;</span><span class="p">:</span><span class="s">u&#39;Â&#39;</span><span class="p">,</span>       <span class="s">r&#39;\^S&#39;</span><span class="p">:</span><span class="s">u&#39;Ŝ&#39;</span><span class="p">,</span>      <span class="s">r&#39;\^s&#39;</span><span class="p">:</span><span class="s">u&#39;ŝ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\&quot;Y&#39;</span><span class="p">:</span><span class="s">u&#39;Ÿ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\~E&#39;</span><span class="p">:</span><span class="s">u&#39;Ẽ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\~e&#39;</span><span class="p">:</span><span class="s">u&#39;ẽ&#39;</span><span class="p">,</span>      <span class="s">r&#39;\~Y&#39;</span><span class="p">:</span><span class="s">u&#39;Ỹ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~y&#39;</span><span class="p">:</span><span class="s">u&#39;ỹ&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Do again for anyone using extra braces.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\`{A}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C1</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`{a}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E0</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{A}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C1</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{a}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E1</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~{A}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C3</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{a}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E2</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{A}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C4</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~{a}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E3</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\&quot;{a}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E4</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`{E}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C8</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{E}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00C9</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`{e}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E8</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{E}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CA</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{e}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00E9</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{E}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CB</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^{e}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EA</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\`{I}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CC</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{e}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EB</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{I}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CD</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`{\i}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EC</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{I}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CE</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{\i}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00ED</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;{I}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00CF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^{\i}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EE</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~{N}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D1</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{\i}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00EF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`{O}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D2</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~{n}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F1</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;{O}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D3</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`{o}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F2</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{O}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D4</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{o}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F3</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~{O}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D5</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{o}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F4</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{O}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D6</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~{o}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F5</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\&quot;{o}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F6</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\`{U}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00D9</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{U}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DA</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\`{u}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00F9</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{U}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DB</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{u}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FA</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{U}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DC</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^{u}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FB</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;{Y}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00DD</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\&quot;{u}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FC</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{y}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FD</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;{y}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u00FF</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\={A}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0100</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\={a}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0101</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{C}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0106</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{c}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0107</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{C}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0108</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{c}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0109</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.{C}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u010A</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.{c}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u010B</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\={E}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0112</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\={e}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0113</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.{E}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0116</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.{e}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0117</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{G}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u011C</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{g}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u011D</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.{G}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0120</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.{g}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0121</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{H}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0124</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{h}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0125</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\~{I}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0128</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~{\i}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0129</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\={I}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u012A</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\={\i}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u012B</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\.{I}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0130</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^{J}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0134</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{\j}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0135</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{L}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0139</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{N}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0143</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{n}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0144</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\={O}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u014C</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\={o}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u014D</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{R}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0154</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{r}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0155</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;{S}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u015A</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{s}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u015B</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\~{U}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0168</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\~{u}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0169</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\={U}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u016A</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\={u}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u016B</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{W}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0174</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&#39;\^{w}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0175</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\^{Y}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0176</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\^{y}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0177</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&quot;\&#39;{Z}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u0179</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">r&quot;\&#39;{z}&quot;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u017A</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\.{Z}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u017B</span><span class="s">&#39;</span><span class="p">,</span>  <span class="s">r&#39;\.{z}&#39;</span><span class="p">:</span><span class="s">u&#39;</span><span class="se">\u017C</span><span class="s">&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\`{Y}&#39;</span><span class="p">:</span><span class="s">u&#39;Ỳ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\`{y}&#39;</span><span class="p">:</span><span class="s">u&#39;ỳ&#39;</span><span class="p">,</span>       <span class="s">r&quot;\&#39;{K}&quot;</span><span class="p">:</span><span class="s">u&#39;Ḱ&#39;</span><span class="p">,</span>      <span class="s">r&quot;\&#39;{k}&quot;</span><span class="p">:</span><span class="s">u&#39;ḱ&#39;</span><span class="p">,</span>
             <span class="s">r&quot;\&#39;{l}&quot;</span><span class="p">:</span><span class="s">u&#39;ĺ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\^{A}&#39;</span><span class="p">:</span><span class="s">u&#39;Â&#39;</span><span class="p">,</span>       <span class="s">r&#39;\^{S}&#39;</span><span class="p">:</span><span class="s">u&#39;Ŝ&#39;</span><span class="p">,</span>      <span class="s">r&#39;\^{s}&#39;</span><span class="p">:</span><span class="s">u&#39;ŝ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\&quot;{Y}&#39;</span><span class="p">:</span><span class="s">u&#39;Ÿ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\~{E}&#39;</span><span class="p">:</span><span class="s">u&#39;Ẽ&#39;</span><span class="p">,</span>       <span class="s">r&#39;\~{e}&#39;</span><span class="p">:</span><span class="s">u&#39;ẽ&#39;</span><span class="p">,</span>      <span class="s">r&#39;\~{Y}&#39;</span><span class="p">:</span><span class="s">u&#39;Ỹ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\~{y}&#39;</span><span class="p">:</span><span class="s">u&#39;ỹ&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c">## Those were easy. Next we look for single-char codes that must be followed by a non-alpha</span>
    <span class="c">## element, so that for example \orange will produce the &quot;\orange&quot; LaTeX command while</span>
    <span class="c">## &quot;{\o}range&quot; or &quot;\o range&quot; will produce &quot;ørange&quot;. Since we&#39;re using regex and not Python&#39;s</span>
    <span class="c">## string objects, we need to replace all backslashes with double-backslashes. Thankfully,</span>
    <span class="c">## no other regex escape characters occur in this list of LaTeX markup for foreign letters.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">r&#39;\AA&#39;</span><span class="p">:</span><span class="s">u&#39;Å&#39;</span><span class="p">,</span> <span class="s">r&#39;\AE&#39;</span><span class="p">:</span><span class="s">u&#39;Æ&#39;</span><span class="p">,</span> <span class="s">r&#39;\aa&#39;</span><span class="p">:</span><span class="s">u&#39;å&#39;</span><span class="p">,</span> <span class="s">r&#39;\ae&#39;</span><span class="p">:</span><span class="s">u&#39;æ&#39;</span><span class="p">,</span> <span class="s">r&#39;\O&#39;</span><span class="p">:</span><span class="s">u&#39;Ø&#39;</span><span class="p">,</span>  <span class="s">r&#39;\o&#39;</span><span class="p">:</span><span class="s">u&#39;ø&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\ss&#39;</span><span class="p">:</span><span class="s">u&#39;ß&#39;</span><span class="p">,</span> <span class="s">r&#39;\i&#39;</span><span class="p">:</span><span class="s">u&#39;ı&#39;</span><span class="p">,</span>  <span class="s">r&#39;\L&#39;</span><span class="p">:</span><span class="s">u&#39;Ł&#39;</span><span class="p">,</span>  <span class="s">r&#39;\l&#39;</span><span class="p">:</span><span class="s">u&#39;ł&#39;</span><span class="p">,</span>  <span class="s">r&#39;\OE&#39;</span><span class="p">:</span><span class="s">u&#39;Œ&#39;</span><span class="p">,</span> <span class="s">r&#39;\oe&#39;</span><span class="p">:</span><span class="s">u&#39;œ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\j&#39;</span><span class="p">:</span><span class="s">u&#39;ȷ&#39;</span><span class="p">,</span>  <span class="s">r&#39;\P&#39;</span><span class="p">:</span><span class="s">u&#39;¶&#39;</span><span class="p">,</span>  <span class="s">r&#39;\S&#39;</span><span class="p">:</span><span class="s">u&#39;§&#39;</span><span class="p">,</span>  <span class="s">r&#39;\DH&#39;</span><span class="p">:</span><span class="s">u&#39;Ð&#39;</span><span class="p">,</span> <span class="s">r&#39;\dh&#39;</span><span class="p">:</span><span class="s">u&#39;ð&#39;</span><span class="p">,</span> <span class="s">r&#39;\DJ&#39;</span><span class="p">:</span><span class="s">u&#39;Đ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\dj&#39;</span><span class="p">:</span><span class="s">u&#39;đ&#39;</span><span class="p">,</span> <span class="s">r&#39;\IJ&#39;</span><span class="p">:</span><span class="s">u&#39;Ĳ&#39;</span><span class="p">,</span> <span class="s">r&#39;\ij&#39;</span><span class="p">:</span><span class="s">u&#39;ĳ&#39;</span><span class="p">,</span> <span class="s">r&#39;\NG&#39;</span><span class="p">:</span><span class="s">u&#39;Ŋ&#39;</span><span class="p">,</span> <span class="s">r&#39;\ng&#39;</span><span class="p">:</span><span class="s">u&#39;ŋ&#39;</span><span class="p">,</span> <span class="s">r&#39;\SS&#39;</span><span class="p">:</span><span class="s">u&#39;ẞ&#39;</span><span class="p">,</span>
             <span class="s">r&#39;\TH&#39;</span><span class="p">:</span><span class="s">u&#39;Þ&#39;</span><span class="p">,</span> <span class="s">r&#39;\th&#39;</span><span class="p">:</span><span class="s">u&#39;þ&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">r&#39;(?!\w)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="parse_bst_template_str"><a class="viewcode-back" href="../bibulous.html#bibulous.parse_bst_template_str">[docs]</a><span class="k">def</span> <span class="nf">parse_bst_template_str</span><span class="p">(</span><span class="n">bst_template_str</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">undefstr</span><span class="o">=</span><span class="s">&#39;???&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    From an &quot;options train&quot; `[...|...|...]`, find the first defined block in the</span>
<span class="sd">    train.</span>

<span class="sd">    A Bibulous type of bibliography style template string contains grammatical featues</span>
<span class="sd">    called options trains, of the form `[...|...|...]`. Each &quot;block&quot; in the train (divided</span>
<span class="sd">    from the others by a `|` symbol), contains fields which, if defined, replace the</span>
<span class="sd">    entire options train in the returned string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bst_template_str : str</span>
<span class="sd">        The string containing a complete entrytype bibliography style template.</span>
<span class="sd">    variables : list of str</span>
<span class="sd">        The list of variables defined within the template string.</span>
<span class="sd">    bibentry : dict</span>
<span class="sd">        An entry from the bibliography database.</span>
<span class="sd">    undefstr : str</span>
<span class="sd">        The string to replace undefined required fields with.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arg : str</span>
<span class="sd">          The string giving the entrytype block to replace an options train.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    parse_bst_template_str() is given an options train &quot;[&lt;title&gt;|&lt;booktitle&gt;]&quot; and begins to</span>
<span class="sd">    look into the bibliography entry. It does not find an &quot;title&quot; entry but finds a &quot;booktitle&quot;</span>
<span class="sd">    entry. So, the function returns &quot;&lt;booktitle&gt;&quot;, thereby replacing the train with the proper</span>
<span class="sd">    defined variable.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">## Divide up the format string into</span>
    <span class="n">block_train</span> <span class="o">=</span> <span class="n">bst_template_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span>
    <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_train</span><span class="p">)</span>

    <span class="c">## Go through the if/elseif/else train of blocks within the string one by one. In each block,</span>
    <span class="c">## see if there are any variables defined (using the backslash). If no variables, then the</span>
    <span class="c">## block is &quot;defined&quot; and we return that block (i.e. replacing the train with that block). If</span>
    <span class="c">## an argument is defined, strip its leading backslash and look to see if the variable is</span>
    <span class="c">## defined in the bibdata entry. If so, the variable is defined and we return the backslash</span>
    <span class="c">## version of the variable (later code will do the variable replacement). If the variable is</span>
    <span class="c">## undefined (not present in the bibdata entry) then skip to the next block. If there is no</span>
    <span class="c">## next block, or if the block is empty (which means undefined by definition) then set the</span>
    <span class="c">## result to be the &quot;undefined string&quot;.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">block_train</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="c">#print(&#39;Required block &quot;&#39; + block + &#39;&quot; in &quot;[&#39; + bst_template_str + &#39;]&quot; is undefined.&#39;)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">undefstr</span>
            <span class="k">break</span>

        <span class="c">## If no variable exists inside the options-block, then just copy the text inside the</span>
        <span class="c">## block.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">block</span>
            <span class="k">break</span>

        <span class="c">## Count how many variables there are in the block. We can&#39;t just use</span>
        <span class="c">## &quot;nvars = block.count(r&#39;\&#39;)&quot; because that would also count the LATEX formatting functions</span>
        <span class="c">## used within the block. Instead, we have to loop through the block string and check each</span>
        <span class="c">## instance of the &quot;variables&quot; list and count *those* one by one.</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">nvars</span> <span class="o">+=</span> <span class="n">block</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="n">vars_found</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">arg_is_defined</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span><span class="o">*</span><span class="n">nvars</span>

        <span class="c">## Loop through the list of variables and find which ones are defined within the</span>
        <span class="c">## bibliography entry.</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>             <span class="c">## remove the angle brackets</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                    <span class="n">arg_is_defined</span><span class="p">[</span><span class="n">vars_found</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">vars_found</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vars_found</span> <span class="o">==</span> <span class="n">nvars</span><span class="p">):</span> <span class="k">break</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">arg_is_defined</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">block</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">return</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="namestr_to_namedict"><a class="viewcode-back" href="../bibulous.html#bibulous.namestr_to_namedict">[docs]</a><span class="k">def</span> <span class="nf">namestr_to_namedict</span><span class="p">(</span><span class="n">namestr</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Take a BibTeX string representing a single person&#39;s name and parse it into its first, middle, \</span>
<span class="sd">    last, etc pieces.</span>

<span class="sd">    BibTeX allows three different styles of author formats.</span>
<span class="sd">        (1) A space-separated list, [firstname middlenames suffix lastname]</span>
<span class="sd">        (2) A two-element comma-separated list, [prefix lastname, firstname middlenames]</span>
<span class="sd">        (3) a three-element comma-separated list, [prefix lastname, suffix, firstname middlenames].</span>
<span class="sd">    So, we can separate these three categories by counting the number of commas that appear.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namestr : str</span>
<span class="sd">        The string containing a single person&#39;s name, in BibTeX format</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        A dictionary with keys &quot;first&quot;, &quot;middle&quot;, &quot;prefix&quot;, &quot;last&quot;, and &quot;suffix&quot;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">## First, if there is a comma within the string, then build the delimiter level list so you</span>
    <span class="c">## can check whether the comma is at delimiter level 0 (and therefore a valid comma for</span>
    <span class="c">## determining name structure). Using this, determine the locations of &quot;valid&quot; commas.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">namestr</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">))</span>
        <span class="n">commapos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">namestr</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">commapos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">commapos</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">## Note: switch on &quot;len(commapos)&quot; here rather than on &quot;(&#39;,&#39; not in namestr)&quot; because the</span>
    <span class="c">## latter will produce an error when the comma occurs at brace levels other than zero.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c">## Allow nametokens to be split by spaces *or* word ties (&#39;~&#39; == unbreakable spaces),</span>
        <span class="c">## except when the &#39;~&#39; is preceded by a backslash, in which case we have the LaTeX markup</span>
        <span class="c">## for the tilde accent. We use &quot;stringsplit()&quot; rather than the standard</span>
        <span class="c">## string object&#39;s &quot;split()&quot; function because we don&#39;t want the split to be applied when</span>
        <span class="c">## the separator is not at brace level zero.</span>
        <span class="n">nametokens</span> <span class="o">=</span> <span class="n">stringsplit</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="s">r&#39; |(?&lt;!</span><span class="se">\\</span><span class="s">)~&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nametokens</span><span class="p">:</span>
            <span class="n">n_temp</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c">## If we find a dot which is not preceded by a backslash and not succeeded by a dash.</span>
            <span class="c">## Also, we shouldn&#39;t care about dots appearing within curle braces, so we have to</span>
            <span class="c">## check for that as well.</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)\.(?!-)&#39;</span><span class="p">,</span> <span class="n">n_temp</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: The name token &quot;&#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s">&#39;&quot; in namestring &quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> \
                          <span class="s">&#39;&quot; has a &quot;.&quot; inside it, which may be a typo. Ignoring ...&#39;</span><span class="p">)</span>

        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">first_nametokens</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">second_nametokens</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">second_nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">second_nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">,</span> <span class="n">thirdpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">first_nametokens</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">second_nametokens</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">third_nametokens</span> <span class="o">=</span> <span class="n">thirdpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">second_nametokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the BibTeX format for namestr=&quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> <span class="s">&#39;&quot; is malformed.&#39;</span> <span class="o">+</span> \
                  <span class="s">&#39;</span><span class="se">\n</span><span class="s">There should be only one name in the second part of the three comma-&#39;</span> \
                  <span class="s">&#39;separated name elements.&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">({</span><span class="s">&#39;last&#39;</span><span class="p">:</span><span class="s">&#39;???&#39;</span><span class="p">})</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">third_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">third_nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">third_nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="c">#if (len(namedict[&#39;middle&#39;]) == 1):</span>
            <span class="c">#    namedict[&#39;middle&#39;] = namedict[&#39;middle&#39;][0]</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="c">## The name format is (first,middle,prefix,last).</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">,</span> <span class="n">thirdpart</span><span class="p">,</span> <span class="n">fourthpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thirdpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourthpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c">#namedict[&#39;suffix&#39;] =</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
        <span class="c">## The name format is (first,middle,prefix,last,suffix).</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">,</span> <span class="n">thirdpart</span><span class="p">,</span> <span class="n">fourthpart</span><span class="p">,</span> <span class="n">fifthpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thirdpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourthpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifthpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the BibTeX format for namestr=&quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> <span class="s">&#39;&quot; is malformed.&#39;</span> <span class="o">+</span> \
              <span class="s">&#39;</span><span class="se">\n</span><span class="s">There should never be more than four commas in a given name.&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">({</span><span class="s">&#39;last&#39;</span><span class="p">:</span><span class="s">&#39;???&#39;</span><span class="p">})</span>

    <span class="c">## If any tokens in the middle name start with lower case, then move them, and any tokens after</span>
    <span class="c">## them, to the prefix. An important difference is that prefixes typically don&#39;t get converted</span>
    <span class="c">## to initials when generating the formatted bibliography string.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;middle&#39;</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">nametokens</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nametokens</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">nametokens</span><span class="p">]</span>
        <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nametokens</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">move</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">movelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">removelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span> <span class="n">move</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">move</span><span class="p">:</span>
                <span class="n">movelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">removelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c">## Add the tokens to the prefix and remove them from the middle name.</span>
        <span class="k">if</span> <span class="n">movelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">):</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">movetokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">movelist</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">movetokens</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">removelist</span><span class="p">:</span>
            <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">removelist</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

<span class="c">## ===================================</span></div>
<div class="viewcode-block" id="search_middlename_for_prefixes"><a class="viewcode-back" href="../bibulous.html#bibulous.search_middlename_for_prefixes">[docs]</a><span class="k">def</span> <span class="nf">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    From the middle name of a single person, check if any of the names should be placed into the</span>
<span class="sd">    &quot;prefix&quot; and move them there.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        The dictionary containing the key &quot;middle&quot;, containing the string with the person&#39;s \</span>
<span class="sd">        middle names/initials.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        The dictionary augmented with the key &quot;prefix&quot; if a prefix is indeed found.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;middle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="c">## Search the list of middle names from the back to the front. If the name encountered starts</span>
    <span class="c">## with lower case, then it is moved to namedict[&#39;prefix&#39;]. If not, then stop the search and</span>
    <span class="c">## break out of the loop.</span>
    <span class="n">middlenames</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">middlenames</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
            <span class="c">#pdb.set_trace()</span>
            <span class="n">prefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">middlenames</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">middlenames</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="create_edition_ordinal"><a class="viewcode-back" href="../bibulous.html#bibulous.create_edition_ordinal">[docs]</a><span class="k">def</span> <span class="nf">create_edition_ordinal</span><span class="p">(</span><span class="n">bibentry</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a bibliography entry&#39;s edition *number*, format it as an ordinal (i.e. &quot;1st&quot;, &quot;2nd&quot; \</span>
<span class="sd">    instead of &quot;1&quot;, &quot;2&quot;) in the way that it will appear on the formatted page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bibdata :  dict</span>
<span class="sd">        The bibliography database dictionary (constructed from *.bib files).</span>
<span class="sd">    key :      str</span>
<span class="sd">        The key in `bibdata` defining the current entry being formatted.</span>
<span class="sd">    options : dict, optional</span>
<span class="sd">        Includes formatting options such as</span>
<span class="sd">        &#39;missing_data_excaptions&#39;: Whether to raise an exception when encountering missing data \</span>
<span class="sd">            errors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    editionstr : str</span>
<span class="sd">        The formatted form of the edition, with ordinal attached.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">## TODO: need to replace the English-locale-dependent approach here with an international</span>
    <span class="c">## friendly approach. Any ideas?</span>

    <span class="c">## First check that the key exists.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">&#39;edition&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
        <span class="c">#print(&#39;Warning: cannot find &quot;edition&quot; in entry &quot;&#39; + key + &#39;&quot;&#39;)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;edition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;edition&#39;</span><span class="p">])</span>

    <span class="n">edition_number</span> <span class="o">=</span> <span class="n">bibentry</span><span class="p">[</span><span class="s">&#39;edition&#39;</span><span class="p">]</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;first&#39;</span><span class="p">:</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">:</span><span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">:</span><span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="s">&#39;fourth&#39;</span><span class="p">:</span><span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;fifth&#39;</span><span class="p">:</span><span class="s">&#39;5&#39;</span><span class="p">,</span> <span class="s">&#39;sixth&#39;</span><span class="p">:</span><span class="s">&#39;6&#39;</span><span class="p">,</span>
             <span class="s">&#39;seventh&#39;</span><span class="p">:</span><span class="s">&#39;7&#39;</span><span class="p">,</span> <span class="s">&#39;eighth&#39;</span><span class="p">:</span><span class="s">&#39;8&#39;</span><span class="p">,</span> <span class="s">&#39;ninth&#39;</span><span class="p">:</span><span class="s">&#39;10&#39;</span><span class="p">,</span> <span class="s">&#39;tenth&#39;</span><span class="p">:</span><span class="s">&#39;10&#39;</span><span class="p">,</span> <span class="s">&#39;eleventh&#39;</span><span class="p">:</span><span class="s">&#39;11&#39;</span><span class="p">,</span>
             <span class="s">&#39;twelfth&#39;</span><span class="p">:</span><span class="s">&#39;12&#39;</span><span class="p">,</span> <span class="s">&#39;thirteenth&#39;</span><span class="p">:</span><span class="s">&#39;13&#39;</span><span class="p">,</span> <span class="s">&#39;fourteenth&#39;</span><span class="p">:</span><span class="s">&#39;14&#39;</span><span class="p">,</span> <span class="s">&#39;fifteenth&#39;</span><span class="p">:</span><span class="s">&#39;15&#39;</span><span class="p">,</span>
             <span class="s">&#39;sixteenth&#39;</span><span class="p">:</span><span class="s">&#39;16&#39;</span><span class="p">,</span> <span class="s">&#39;seventeenth&#39;</span><span class="p">:</span><span class="s">&#39;17&#39;</span><span class="p">,</span> <span class="s">&#39;eighteenth&#39;</span><span class="p">:</span><span class="s">&#39;18&#39;</span><span class="p">,</span> <span class="s">&#39;nineteenth&#39;</span><span class="p">:</span><span class="s">&#39;19&#39;</span><span class="p">,</span>
             <span class="s">&#39;twentieth&#39;</span><span class="p">:</span><span class="s">&#39;20&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">edition_number</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="n">edition_number</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="n">edition_number</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="c">## Add the ordinal string to the number.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">edition_number</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">):</span>
        <span class="n">editionstr</span> <span class="o">=</span> <span class="s">&#39;1st&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">edition_number</span> <span class="o">==</span> <span class="s">&#39;2&#39;</span><span class="p">):</span>
        <span class="n">editionstr</span> <span class="o">=</span> <span class="s">&#39;2nd&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">edition_number</span> <span class="o">==</span> <span class="s">&#39;3&#39;</span><span class="p">):</span>
        <span class="n">editionstr</span> <span class="o">=</span> <span class="s">&#39;3rd&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">edition_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">editionstr</span> <span class="o">=</span> <span class="n">edition_number</span> <span class="o">+</span> <span class="s">&#39;th&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;edition&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the edition number &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">edition_number</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot; given for entry &#39;</span> <span class="o">+</span> \
                  <span class="n">key</span> <span class="o">+</span> <span class="s">&#39; is invalid. Ignoring&#39;</span><span class="p">)</span>
            <span class="n">editionstr</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;undefstr&#39;</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">editionstr</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="export_bibfile"><a class="viewcode-back" href="../bibulous.html#bibulous.export_bibfile">[docs]</a><span class="k">def</span> <span class="nf">export_bibfile</span><span class="p">(</span><span class="n">bibdata</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write a bibliography database dictionary into a .bib file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The filename of the file to write.</span>
<span class="sd">    bibdata : dict</span>
<span class="sd">        The bibliography dictionary to write out.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">),</span> <span class="s">&#39;Input &quot;filename&quot; must be a string.&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bibdata</span><span class="p">:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="s">&#39;entrytype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;{&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;,</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;entrytype&#39;</span><span class="p">]</span>
        <span class="n">nkeys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c">## Write out the entries.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s">&#39; = {&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;}&#39;</span><span class="p">)</span>

            <span class="c">## If this is the last field in the dictionary, then do not end the line with a</span>
            <span class="c">## trailing comma.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nkeys</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;,</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;}</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="parse_pagerange"><a class="viewcode-back" href="../bibulous.html#bibulous.parse_pagerange">[docs]</a><span class="k">def</span> <span class="nf">parse_pagerange</span><span class="p">(</span><span class="n">pages_str</span><span class="p">,</span> <span class="n">citekey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a string containing the &quot;pages&quot; field of a bibliographic entry, figure out the start and</span>
<span class="sd">    end pages.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pages_str : str</span>
<span class="sd">        The string to parse.</span>
<span class="sd">    citekey : str, optional</span>
<span class="sd">        The citation key (useful for debugging messages).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    startpage : str</span>
<span class="sd">        The starting page.</span>
<span class="sd">    endpage : str</span>
<span class="sd">        The ending page. If endpage==startpage, then endpage is set to None.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pages_str</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c">## Note that we work with strings instead of integers, because the use of letters in article</span>
    <span class="c">## pages is common (e.g. page &quot;D5&quot;).</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">pages_str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">pages_str</span><span class="p">):</span>
        <span class="n">pagesplit</span> <span class="o">=</span> <span class="n">multisplit</span><span class="p">(</span><span class="n">pages_str</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
        <span class="n">startpage</span> <span class="o">=</span> <span class="n">pagesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">endpage</span> <span class="o">=</span> <span class="n">pagesplit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">endpage</span> <span class="o">==</span> <span class="n">startpage</span><span class="p">):</span> <span class="n">endpage</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">startpage</span> <span class="o">=</span> <span class="n">pages_str</span>
        <span class="n">endpage</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">## For user convenience, add a check here that if endpage and startpages are both numbers and</span>
    <span class="c">## endpage &lt;= startpage, then there is a typo.</span>
    <span class="k">if</span> <span class="n">startpage</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">endpage</span> <span class="ow">and</span> <span class="n">endpage</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">endpage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">startpage</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">citekey</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the &quot;pages&quot; field in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">citekey</span> <span class="o">+</span> <span class="s">&#39;&quot; has a malformed page&#39;</span>
                      <span class="s">&#39;range (endpage &lt; startpage). Ignoring ...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: the &quot;pages&quot; field &quot;&#39;</span> <span class="o">+</span> <span class="n">pages_str</span> <span class="o">+</span> <span class="s">&#39;&quot; is malformed, since endpage &#39;</span>
                      <span class="s">&#39;&lt; startpage. Ignoring ...&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">startpage</span><span class="p">,</span> <span class="n">endpage</span><span class="p">)</span>

<span class="c">## =============================</span></div>
<div class="viewcode-block" id="parse_nameabbrev"><a class="viewcode-back" href="../bibulous.html#bibulous.parse_nameabbrev">[docs]</a><span class="k">def</span> <span class="nf">parse_nameabbrev</span><span class="p">(</span><span class="n">abbrevstr</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a string containing either a single &quot;name&quot; &gt; &quot;abbreviation&quot; pair or a list of such pairs,</span>
<span class="sd">    parse the string into a dictionary of names and abbreviations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    abbrevstr : str</span>
<span class="sd">        The string containing the abbreviation definitions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nameabbrev_dict : dict</span>
<span class="sd">        A dictionary with names for keys and abbreviations for values.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">abbrevlist</span> <span class="o">=</span> <span class="n">abbrevstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">abbrevlist</span><span class="p">:</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &gt; &#39;</span><span class="p">)</span>
        <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">nameabbrev_dict</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">nameabbrev_dict</span><span class="p">)</span>



<span class="c">## ==================================================================================================</span>
</div>
<span class="k">if</span> <span class="p">(</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;sys.argv=&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;locale=&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">GetoptError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c"># print help information and exit:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="c"># will print something like &quot;option -a not recognized&quot;</span>
            <span class="c">## Add some print statements here telling the user the basic interface to the function.</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s">&#39;--locale&#39;</span><span class="p">):</span>
                <span class="n">locale</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&quot;unhandled option&quot;</span>

        <span class="c">## Use this command on the command line:</span>
        <span class="c">#/home/nh/Lab\ Notes/Bibulous/biblatex.py /home/nh/Publications/2013\ OE\ -\ Review\ of\ Snapshot/snapshot_review.tex /home/nh/Lab\ Notes/Bibulous/osa.bst</span>
        <span class="c">#arg_texfile = sys.argv[0]</span>
        <span class="n">arg_auxfile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">#if (arg_texfile[0] != &#39;/&#39;):</span>
        <span class="c">#    arg_texfile = os.getcwd() + &#39;/&#39; + arg_texfile</span>
        <span class="c">#files = [arg_texfile, arg_auxfile]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">arg_auxfile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">## Use the test example input.</span>
        <span class="n">arg_bibfile</span> <span class="o">=</span> <span class="s">&#39;./test/test1.bib&#39;</span>
        <span class="n">arg_auxfile</span> <span class="o">=</span> <span class="s">&#39;./test/test1.aux&#39;</span>
        <span class="n">arg_bstfile</span> <span class="o">=</span> <span class="s">&#39;./test/test1.bst&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg_bibfile</span><span class="p">,</span> <span class="n">arg_auxfile</span><span class="p">,</span> <span class="n">arg_bstfile</span><span class="p">]</span>

    <span class="n">bibdata</span> <span class="o">=</span> <span class="n">Bibdata</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bibdata</span><span class="o">.</span><span class="n">write_bblfile</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Writing to BBL file = &#39;</span> <span class="o">+</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s">&#39;bbl&#39;</span><span class="p">])</span>
    <span class="c">#os.system(&#39;kwrite &#39; + bibdata.filedict[&#39;bbl&#39;])</span>


    <span class="k">print</span><span class="p">(</span><span class="s">&#39;DONE&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Bibulous developers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>